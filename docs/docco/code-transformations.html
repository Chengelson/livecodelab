<!DOCTYPE html>  <html> <head>   <title>code-transformations.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="code-transformations.html">                 code-transformations.js               </a>                                           <a class="source" href="coffeescript-livecodelab-mode.html">                 coffeescript-livecodelab-mode.js               </a>                                           <a class="source" href="editor.html">                 editor.js               </a>                                           <a class="source" href="mousewheel.html">                 mousewheel.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               code-transformations.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="comment">/*jslint maxerr: 200, browser: true, regexp: true, bitwise: true */</span>
<span class="comment">/*global autocoder, createCodeChecker */</span>


<span class="keyword">var</span> createCodeTransformer = <span class="function"><span class="keyword">function</span> <span class="params">(eventRouter, CoffeeCompiler, liveCodeLabCoreInstance)</span> {</span>

    <span class="string">'use strict'</span>;

    <span class="keyword">var</span> CodeTransformer = {},
        programHasBasicError = <span class="literal">false</span>,
        compiledOutput,
        listOfPossibleFunctions,
        preprocessingFunctions = {},
        CodeChecker = createCodeChecker();


    CodeTransformer.compiler = CoffeeCompiler;

    listOfPossibleFunctions = [
        <span class="string">"function"</span>,
        <span class="string">"alert"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Geometry</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"rect"</span>,
        <span class="string">"line"</span>,
        <span class="string">"box"</span>,
        <span class="string">"ball"</span>,
        <span class="string">"ballDetail"</span>,
        <span class="string">"peg"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Matrix manipulation</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"rotate"</span>,
        <span class="string">"move"</span>,
        <span class="string">"scale"</span>,
        <span class="string">"pushMatrix"</span>,
        <span class="string">"popMatrix"</span>,
        <span class="string">"resetMatrix"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Sound</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"bpm"</span>,
        <span class="string">"play"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Color and drawing styles</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"fill"</span>,
        <span class="string">"noFill"</span>,
        <span class="string">"stroke"</span>,
        <span class="string">"noStroke"</span>,
        <span class="string">"strokeSize"</span>,
        <span class="string">"animationStyle"</span>,
        <span class="string">"background"</span>,
        <span class="string">"simpleGradient"</span>,
        <span class="string">"color"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Lighting</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="comment">/*"ambient","reflect", "refract", */</span>
        <span class="string">"lights"</span>,
        <span class="string">"noLights"</span>,
        <span class="string">"ambientLight"</span>,
        <span class="string">"pointLight"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Calculations</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"abs"</span>,
        <span class="string">"ceil"</span>,
        <span class="string">"constrain"</span>,
        <span class="string">"dist"</span>,
        <span class="string">"exp"</span>,
        <span class="string">"floor"</span>,
        <span class="string">"lerp"</span>,
        <span class="string">"log"</span>,
        <span class="string">"mag"</span>,
        <span class="string">"map"</span>,
        <span class="string">"max"</span>,
        <span class="string">"min"</span>,
        <span class="string">"norm"</span>,
        <span class="string">"pow"</span>,
        <span class="string">"round"</span>,
        <span class="string">"sq"</span>,
        <span class="string">"sqrt"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Trigonometry</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"acos"</span>,
        <span class="string">"asin"</span>,
        <span class="string">"atan"</span>,
        <span class="string">"atan2"</span>,
        <span class="string">"cos"</span>,
        <span class="string">"degrees"</span>,
        <span class="string">"radians"</span>,
        <span class="string">"sin"</span>,
        <span class="string">"tan"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Random</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"random"</span>,
        <span class="string">"randomSeed"</span>,
        <span class="string">"noise"</span>,
        <span class="string">"noiseDetail"</span>,
        <span class="string">"noiseSeed"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>do once</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"addDoOnce"</span>,
        <span class="string">""</span>];

    <span class="comment">/**
     * The preprocessing functions are used to process the
     * code before it is sent through the coffee script
     * compiler
     *
     * Note
     * some replacements add a semicolon for the following reason:
     * coffeescript allows you to split arguments over multiple lines.
     * So if you have:
     *     rotate 0,0,1
     *     box
     * and you want to add a scale like so:
     *     scale 2,2,2
     *     rotate 0,0,1
     *     box
     * What happens is that as you are in the middle of typing:
     *     scale 2,
     *     rotate 0,0,1
     *     box
     * coffeescript takes the rotate as the second argument of scale
     * causing mayhem.
     * Instead, all is good if rotate is prepended with a semicolon.
     */</span>


    <span class="comment">/**
     * Stops ticked doOnce blocks from running
     *
     * doOnce statements which have a tick mark next to them
     * are not run. This is achieved by replacing the line with
     * the "doOnce" with "if false" or "//" depending on whether
     * the doOnce is a multiline or an inline one, like so:
     *      ✓doOnce -&gt;
     *        background 255
     *        fill 255,0,0
     *      ✓doOnce -&gt; ball
     * becomes:
     *      if false -&gt;
     *        background 255
     *        fill 255,0,0
     *      //doOnce -&gt; ball
     *
     * @param {string} code    the code to re-write
     *
     * @returns {string}
     */</span>
    CodeTransformer.removeTickedDoOnce = <span class="function"><span class="keyword">function</span> <span class="params">(code)</span> {</span> <span class="comment">// was a preprocessing part</span>
        <span class="keyword">var</span> newCode;
        newCode = code.replace(<span class="regexp">/^(\s)*✓[ ]*doOnce[ ]*\-\&gt;[ ]*$/gm</span>, <span class="string">"$1if false"</span>);
        newCode = newCode.replace(<span class="regexp">/\u2713/g</span>, <span class="string">"//"</span>);
        <span class="keyword">return</span> newCode;
    };

    <span class="comment">/**
     * Some of the functions can be used with postfix notation
     *
     * e.g.
     *
     *      60 bpm
     *      red fill
     *      yellow stroke
     *      black background
     *
     * We need to switch this round before coffee script compilation
     */</span>
    preprocessingFunctions.postfixNotation = <span class="function"><span class="keyword">function</span> <span class="params">(code)</span> {</span>
        <span class="keyword">var</span> elaboratedSource;
        elaboratedSource = code.replace(<span class="regexp">/(\d+)[ ]+bpm(\s)/g</span>, <span class="string">"bpm $1$2"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([a-zA-Z]+)[ ]+fill(\s)/g</span>, <span class="string">"fill $1$2"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([a-zA-Z]+)[ ]+stroke(\s)/g</span>, <span class="string">"stroke $1$2"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([a-zA-Z]+)[ ]+background(\s)/g</span>, <span class="string">"background $1$2"</span>);
        <span class="keyword">return</span> elaboratedSource;
    };

    <span class="comment">/**
     * The times function is mangled by coffeescript
     *     (1).times -&gt;
     * But this isn't:
     *     (1+0).times -&gt;
     * So here is the little replace.
     *
     * TODO: you should be a little smarter about the substitution of the draw method
     * You can tell a method declaration because the line below is indented
     * so you should check that.
     *
     */</span>
    preprocessingFunctions.fixTimesFunctions = <span class="function"><span class="keyword">function</span> <span class="params">(code)</span> {</span>
        <span class="keyword">return</span> code.replace(<span class="regexp">/(\d+)\s+times[ ]*\-&gt;/g</span>, <span class="string">";( $1 + 0).times -&gt;"</span>);
    };

    <span class="comment">/**
     * Each doOnce block is made to start with an instruction that traces whether
     * the block has been run or not. This allows us to put back the tick where
     * necessary, so the doOnce block is not run again.
     * Example - let's say one pastes in this code:
     *     doOnce -&gt;
     *         background 255
     *         fill 255,0,0
     *
     *     doOnce -&gt; ball
     *
     * it becomes:
     *     (1+0).times -&gt;
     *         addDoOnce(1); background 255
     *         fill 255,0,0
     *
     *     ;addDoOnce(4);
     *     (1+0).times -&gt; ball
     *    
     * So: if there is at least one doOnce
     *     split the source in lines
     *     add line numbers tracing instructions so we can track which ones have been run
     *     regroup the lines into a single string again
     *
     */</span>
    preprocessingFunctions.addDoOnceTracing = <span class="function"><span class="keyword">function</span> <span class="params">(source)</span> {</span>
        <span class="keyword">var</span> sourceLines, i;
        <span class="keyword">if</span> (source.indexOf(<span class="string">'doOnce'</span>) &gt; -<span class="number">1</span>) {
            sourceLines = source.split(<span class="string">"\n"</span>);
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sourceLines.length; i += <span class="number">1</span>) {

</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>add the line number tracing instruction to inline case</p>             </td>             <td class="code">               <div class="highlight"><pre>                sourceLines[i] = sourceLines[i].replace(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*(.+)$/gm</span>, <span class="string">"$1;addDoOnce("</span> + i + <span class="string">"); (1+0).times -&gt; $2"</span>);

</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>add the line number tracing instruction to multiline case</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="keyword">if</span> (sourceLines[i].match(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/gm</span>)) {
                    sourceLines[i] = sourceLines[i].replace(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/gm</span>, <span class="string">"$1(1+0).times -&gt;"</span>);
                    sourceLines[i + <span class="number">1</span>] = sourceLines[i + <span class="number">1</span>].replace(<span class="regexp">/^(\s*)(.+)$/gm</span>, <span class="string">"$1;addDoOnce("</span> + i + <span class="string">"); $2"</span>);
                }

            }
            source = sourceLines.join(<span class="string">"\n"</span>);
        }
        <span class="keyword">return</span> source;
    };

    <span class="keyword">var</span> doesProgramContainStringsOrComments = <span class="function"><span class="keyword">function</span> <span class="params">(updatedCodeAsString)</span> {</span>
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>make a copy of the string because we are going to
slice it in the process.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="keyword">var</span> copyOfUpdatedCodeAsString = updatedCodeAsString;
            <span class="keyword">var</span> characterBeingExamined, nextCharacterBeingExamined;
            <span class="keyword">while</span> (copyOfUpdatedCodeAsString.length) {
                characterBeingExamined = copyOfUpdatedCodeAsString.charAt(<span class="number">0</span>);
                nextCharacterBeingExamined = copyOfUpdatedCodeAsString.charAt(<span class="number">1</span>);
                <span class="keyword">if</span> (characterBeingExamined === <span class="string">"'"</span> || characterBeingExamined === <span class="string">'"'</span> || (characterBeingExamined === <span class="string">"/"</span> &amp;&amp;
                        (nextCharacterBeingExamined === <span class="string">"*"</span> || nextCharacterBeingExamined === <span class="string">"/"</span>))
                        ) {
                    <span class="keyword">return</span> <span class="literal">true</span>;
                }
                copyOfUpdatedCodeAsString = copyOfUpdatedCodeAsString.slice(<span class="number">1</span>);
            }
    }

    CodeTransformer.stripCommentsAndCheckBasicSyntax = <span class="function"><span class="keyword">function</span> <span class="params">(updatedCodeAsString)</span> {</span> <span class="comment">// was a standalone function</span>
			<span class="keyword">var</span> codeWithoutComments, codeWithoutStringsOrComments;
			
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>check whether the program potentially
contains strings or comments
if it doesn't then we can do some
simple syntactic checks that are likely
to be much faster than attempting a
coffescript to javascript translation</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>let's do a quick check:
these groups of characters should be in even number:
", ', (), {}, []
Note that this doesn't check nesting, so for example
[{]} does pass the test.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="keyword">if</span> (doesProgramContainStringsOrComments(updatedCodeAsString)) {
</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>OK the program contains comments and/or strings
so this is what we are going to do:
first we remove all the comments for good
then we create a version without the strings
so we can perform some basic syntax checking.
Note that when we remove the comments we also need to
take into account strings because otherwise we mangle a line like
print "frame/100 //"
where we need to now that that single comment is actually the content
of a string.
modified from Processing.js (search for: "masks strings and regexs")
this is useful to remove all comments but keeping all the strings
the difference is that here I don't treat regular expressions.
Note that string take precedence over comments i.e.
is a string, not half a string with a quote in a comment
get rid of the comments for good.</p>             </td>             <td class="code">               <div class="highlight"><pre>					updatedCodeAsString = updatedCodeAsString.replace(<span class="regexp">/("(?:[^"\\\n]|\\.)*")|('(?:[^'\\\n]|\\.)*')|(\/\/[^\n]*\n)|(\/\*(?:(?!\*\/)(?:.|\n))*\*\/)/g</span>,
					
					  <span class="function"><span class="keyword">function</span> <span class="params">(all, quoted, aposed, singleComment, comment)</span> {</span>
							<span class="keyword">var</span> numberOfLinesInMultilineComment,
									rebuiltNewLines,
									cycleToRebuildNewLines;
</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>strings are kept as they are</p>             </td>             <td class="code">               <div class="highlight"><pre>							<span class="keyword">if</span> (quoted) {
									<span class="keyword">return</span> quoted;
							}
							<span class="keyword">if</span> (aposed) {
									<span class="keyword">return</span> aposed;
							}
							<span class="keyword">if</span> (singleComment) {
</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>preserve the line because
the doOnce mechanism needs to retrieve
the line where it was</p>             </td>             <td class="code">               <div class="highlight"><pre>									<span class="keyword">return</span> <span class="string">"\n"</span>;
							}
</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>eliminate multiline comments preserving the lines</p>             </td>             <td class="code">               <div class="highlight"><pre>							numberOfLinesInMultilineComment = comment.split(<span class="string">"\n"</span>).length - <span class="number">1</span>;
							rebuiltNewLines = <span class="string">''</span>;
							<span class="keyword">for</span> (cycleToRebuildNewLines = <span class="number">0</span>; cycleToRebuildNewLines &lt; numberOfLinesInMultilineComment; cycleToRebuildNewLines += <span class="number">1</span>) {
									rebuiltNewLines = rebuiltNewLines + <span class="string">"\n"</span>;
							}
							<span class="keyword">return</span> rebuiltNewLines;
					});

					codeWithoutComments = updatedCodeAsString;
</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>ok now in the version we use for syntax checking we delete all the strings</p>             </td>             <td class="code">               <div class="highlight"><pre>					codeWithoutStringsOrComments = updatedCodeAsString.replace(<span class="regexp">/("(?:[^"\\\n]|\\.)*")|('(?:[^'\\\n]|\\.)*')/g</span>, <span class="string">""</span>);

			} <span class="keyword">else</span> {
					codeWithoutStringsOrComments = updatedCodeAsString;
			}

			<span class="keyword">var</span> aposCount = <span class="number">0</span>;
			<span class="keyword">var</span> quoteCount = <span class="number">0</span>;
			<span class="keyword">var</span> roundBrackCount = <span class="number">0</span>;
			<span class="keyword">var</span> curlyBrackCount = <span class="number">0</span>;
			<span class="keyword">var</span> squareBrackCount = <span class="number">0</span>;
			<span class="keyword">var</span> characterBeingExamined;
			<span class="keyword">var</span> reasonOfBasicError;

			<span class="keyword">while</span> (codeWithoutStringsOrComments.length) {
					characterBeingExamined = codeWithoutStringsOrComments.charAt(<span class="number">0</span>);

					<span class="keyword">if</span> (characterBeingExamined === <span class="string">"'"</span>) {
							aposCount += <span class="number">1</span>;
					} <span class="keyword">else</span> <span class="keyword">if</span> (characterBeingExamined === <span class="string">'"'</span>) {
							quoteCount += <span class="number">1</span>;
					} <span class="keyword">else</span> <span class="keyword">if</span> (characterBeingExamined === <span class="string">'('</span> || characterBeingExamined === <span class="string">')'</span>) {
							roundBrackCount += <span class="number">1</span>;
					} <span class="keyword">else</span> <span class="keyword">if</span> (characterBeingExamined === <span class="string">'{'</span> || characterBeingExamined === <span class="string">'}'</span>) {
							curlyBrackCount += <span class="number">1</span>;
					} <span class="keyword">else</span> <span class="keyword">if</span> (characterBeingExamined === <span class="string">'['</span> || characterBeingExamined === <span class="string">']'</span>) {
							squareBrackCount += <span class="number">1</span>;
					}
					codeWithoutStringsOrComments = codeWithoutStringsOrComments.slice(<span class="number">1</span>);
			}

</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>according to jsperf, the fastest way to check if number is even/odd</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="keyword">if</span> (aposCount &amp; <span class="number">1</span> || quoteCount &amp; <span class="number">1</span> || roundBrackCount &amp; <span class="number">1</span> || curlyBrackCount &amp; <span class="number">1</span> || squareBrackCount &amp; <span class="number">1</span>) {

					programHasBasicError = <span class="literal">true</span>;

					<span class="keyword">if</span> (aposCount &amp; <span class="number">1</span>) {
							reasonOfBasicError = <span class="string">"Missing '"</span>;
					}
					<span class="keyword">if</span> (quoteCount &amp; <span class="number">1</span>) {
							reasonOfBasicError = <span class="string">'Missing "'</span>;
					}
					<span class="keyword">if</span> (roundBrackCount &amp; <span class="number">1</span>) {
							reasonOfBasicError = <span class="string">"Unbalanced ()"</span>;
					}
					<span class="keyword">if</span> (curlyBrackCount &amp; <span class="number">1</span>) {
							reasonOfBasicError = <span class="string">"Unbalanced {}"</span>;
					}
					<span class="keyword">if</span> (squareBrackCount &amp; <span class="number">1</span>) {
							reasonOfBasicError = <span class="string">"Unbalanced []"</span>;
					}

					eventRouter.trigger(<span class="string">'compile-time-error-thrown'</span>, reasonOfBasicError);


					<span class="keyword">return</span> <span class="literal">null</span>;
			}

</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>no comments or strings were found, just return the same string
that was passed</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="keyword">return</span> updatedCodeAsString

    }

    CodeTransformer.addTracingInstructionsToDoOnceBlocks = <span class="function"><span class="keyword">function</span> <span class="params">(updatedCodeAsString)</span> {</span> <span class="comment">// was a standalone function</span>
</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>ADDING TRACING INSTRUCTION TO THE DOONCE BLOCKS
each doOnce block is made to start with an instruction that traces whether
the block has been run or not. This allows us to put back the tick where
necessary, so the doOnce block is not run again.
Example - let's say one pastes in this code:
     doOnce ->
       background 255
       fill 255,0,0</p>

<pre><code> doOnce -&gt; ball
</code></pre>

<p>it becomes:
     (1+0).times ->
       addDoOnce(1); background 255
       fill 255,0,0</p>

<pre><code> ;addDoOnce(4);
 (1+0).times -&gt; ball
</code></pre>

<p>So: if there is at least one doOnce
  split the source in lines
  add line numbers tracing instructions so we can track which ones have been run
  regroup the lines into a single string again</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="keyword">var</span> elaboratedSourceByLine, iteratingOverSource;
            <span class="keyword">if</span> (updatedCodeAsString.indexOf(<span class="string">'doOnce'</span>) &gt; -<span class="number">1</span>) {
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>alert("a doOnce is potentially executable");</p>             </td>             <td class="code">               <div class="highlight"><pre>                elaboratedSourceByLine = updatedCodeAsString.split(<span class="string">"\n"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>alert('splitting: ' + elaboratedSourceByLine.length );</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="keyword">for</span> (iteratingOverSource = <span class="number">0</span>; iteratingOverSource &lt; elaboratedSourceByLine.length; iteratingOverSource += <span class="number">1</span>) {
</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>alert('iterating: ' + iteratingOverSource );</p>             </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>add the line number tracing instruction to inline case</p>             </td>             <td class="code">               <div class="highlight"><pre>                    elaboratedSourceByLine[iteratingOverSource] = elaboratedSourceByLine[iteratingOverSource].replace(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*(.+)$/gm</span>, <span class="string">"$1;addDoOnce("</span> + iteratingOverSource + <span class="string">"); (1+0).times -&gt; $2"</span>);

</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>add the line number tracing instruction to multiline case</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="keyword">if</span> (elaboratedSourceByLine[iteratingOverSource].match(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/gm</span>)) {
</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>alert('doOnce multiline!');</p>             </td>             <td class="code">               <div class="highlight"><pre>                        elaboratedSourceByLine[iteratingOverSource] = elaboratedSourceByLine[iteratingOverSource].replace(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/gm</span>, <span class="string">"$1(1+0).times -&gt;"</span>);
                        elaboratedSourceByLine[iteratingOverSource + <span class="number">1</span>] = elaboratedSourceByLine[iteratingOverSource + <span class="number">1</span>].replace(<span class="regexp">/^(\s*)(.+)$/gm</span>, <span class="string">"$1;addDoOnce("</span> + iteratingOverSource + <span class="string">"); $2"</span>);
                    }

                }
                updatedCodeAsString = elaboratedSourceByLine.join(<span class="string">"\n"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>alert('soon after replacing doOnces'+updatedCodeAsString);</p>             </td>             <td class="code">               <div class="highlight"><pre>            }
            <span class="keyword">return</span> updatedCodeAsString;
    }




    <span class="keyword">return</span> CodeTransformer;

};

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 