<!DOCTYPE html>  <html> <head>   <title>code-transformations.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-loop.html">                 animation-loop.coffee               </a>                                           <a class="source" href="autocode.html">                 autocode.coffee               </a>                                           <a class="source" href="mclexer.html">                 mclexer.coffee               </a>                                           <a class="source" href="background-painting.html">                 background-painting.coffee               </a>                                           <a class="source" href="big-cursor-animation.html">                 big-cursor-animation.coffee               </a>                                           <a class="source" href="blend-style.html">                 blend-style.coffee               </a>                                           <a class="source" href="code-transformations.html">                 code-transformations.coffee               </a>                                           <a class="source" href="colour-definitions.html">                 colour-definitions.coffee               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.coffee               </a>                                           <a class="source" href="demos-and-tutorials.html">                 demos-and-tutorials.coffee               </a>                                           <a class="source" href="draw-function-runner.html">                 draw-function-runner.coffee               </a>                                           <a class="source" href="editor.html">                 editor.coffee               </a>                                           <a class="source" href="events.html">                 events.coffee               </a>                                           <a class="source" href="globals.html">                 globals.coffee               </a>                                           <a class="source" href="graphic-primitives.html">                 graphic-primitives.coffee               </a>                                           <a class="source" href="init-threejs.html">                 init-threejs.coffee               </a>                                           <a class="source" href="init.html">                 init.coffee               </a>                                           <a class="source" href="lights-functions.html">                 lights-functions.coffee               </a>                                           <a class="source" href="livecodelab-core.html">                 livecodelab-core.coffee               </a>                                           <a class="source" href="math.html">                 math.coffee               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.coffee               </a>                                           <a class="source" href="renderer.html">                 renderer.coffee               </a>                                           <a class="source" href="simple-error-checker.html">                 simple-error-checker.coffee               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.coffee               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.coffee               </a>                                           <a class="source" href="ui.html">                 ui.coffee               </a>                                           <a class="source" href="url-router.html">                 url-router.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               code-transformations.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="class"><span class="keyword">class</span> <span class="title">CodeTransformer</span></span>
  currentCodeString: <span class="literal">null</span>
  
  constructor: (<span class="property">@eventRouter</span>, <span class="property">@CoffeeCompiler</span>, <span class="property">@liveCodeLabCoreInstance</span>) -&gt;
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>note that this is not used anywhere for the time being.</p>             </td>             <td class="code">               <div class="highlight"><pre>    listOfPossibleFunctions = [
      <span class="string">"function"</span>
      <span class="string">"alert"</span>
</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Geometry</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="string">"rect"</span>
      <span class="string">"line"</span>
      <span class="string">"box"</span>
      <span class="string">"ball"</span>
      <span class="string">"ballDetail"</span>
      <span class="string">"peg"</span>
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Matrix manipulation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="string">"rotate"</span>
      <span class="string">"move"</span>
      <span class="string">"scale"</span>
      <span class="string">"pushMatrix"</span>
      <span class="string">"popMatrix"</span>
      <span class="string">"resetMatrix"</span>
</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Sound</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="string">"bpm"</span>
      <span class="string">"play"</span>
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Color and drawing styles</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="string">"fill"</span>
      <span class="string">"noFill"</span>
      <span class="string">"stroke"</span>
      <span class="string">"noStroke"</span>
      <span class="string">"strokeSize"</span>
      <span class="string">"animationStyle"</span>
      <span class="string">"background"</span>
      <span class="string">"simpleGradient"</span>
      <span class="string">"colorMode"</span>
      <span class="string">"color"</span>
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Lighting
"ambient""reflect" "refract"</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="string">"lights"</span>
      <span class="string">"noLights"</span>
      <span class="string">"ambientLight"</span>
      <span class="string">"pointLight"</span>
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Calculations</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="string">"abs"</span>
      <span class="string">"ceil"</span>
      <span class="string">"constrain"</span>
      <span class="string">"dist"</span>
      <span class="string">"exp"</span>
      <span class="string">"floor"</span>
      <span class="string">"lerp"</span>
      <span class="string">"log"</span>
      <span class="string">"mag"</span>
      <span class="string">"map"</span>
      <span class="string">"max"</span>
      <span class="string">"min"</span>
      <span class="string">"norm"</span>
      <span class="string">"pow"</span>
      <span class="string">"round"</span>
      <span class="string">"sq"</span>
      <span class="string">"sqrt"</span>
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Trigonometry</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="string">"acos"</span>
      <span class="string">"asin"</span>
      <span class="string">"atan"</span>
      <span class="string">"atan2"</span>
      <span class="string">"cos"</span>
      <span class="string">"degrees"</span>
      <span class="string">"radians"</span>
      <span class="string">"sin"</span>
      <span class="string">"tan"</span>
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Random</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="string">"random"</span>
      <span class="string">"randomSeed"</span>
      <span class="string">"noise"</span>
      <span class="string">"noiseDetail"</span>
      <span class="string">"noiseSeed"</span>
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>do once</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="string">"addDoOnce"</span>
    ]


</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>  Stops ticked doOnce blocks from running
  
  doOnce statements which have a tick mark next to them
  are <span class="keyword">not</span> run. This <span class="keyword">is</span> achieved <span class="keyword">by</span> replacing the line <span class="reserved">with</span>
  the <span class="string">"doOnce"</span> <span class="reserved">with</span> <span class="string">"if false"</span> <span class="keyword">or</span> <span class="string">"//"</span> depending <span class="literal">on</span> whether
  the doOnce <span class="keyword">is</span> a multiline <span class="keyword">or</span> an inline one, like so:
  ✓doOnce -&gt;
  background <span class="number">255</span>
  fill <span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>
  ✓doOnce -&gt; ball
  becomes:
  <span class="keyword">if</span> <span class="literal">false</span> -&gt;
  background <span class="number">255</span>
  fill <span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>
  <span class="regexp">//</span>doOnce -&gt; ball
  
  <span class="property">@param</span> {string} code    the code to re-write
  
  <span class="property">@returns</span> {string}
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>  removeTickedDoOnce: (code) -&gt;
    newCode = <span class="literal">undefined</span>
    newCode = code.replace(<span class="regexp">/^(\s)*✓[ ]*doOnce[ ]*\-\&gt;[ ]*$/gm</span>, <span class="string">"$1if false"</span>)
    newCode = newCode.replace(<span class="regexp">/\u2713/g, "//</span><span class="string">")
    newCode

  addTracingInstructionsToDoOnceBlocks: (code) -&gt;
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>ADDING TRACING INSTRUCTION TO THE DOONCE BLOCKS
each doOnce block is made to start with an instruction that traces whether
the block has been run or not. This allows us to put back the tick where
necessary, so the doOnce block is not run again.
Example - let's say one pastes in this code:
     doOnce ->
       background 255
       fill 255,0,0</p>

<pre><code> doOnce -&gt; ball
</code></pre>

<p>it becomes:
     (1+0).times ->
       addDoOnce(1); background 255
       fill 255,0,0</p>

<pre><code> ;addDoOnce(4);
 (1+0).times -&gt; ball
</code></pre>

<p>So: if there is at least one doOnce
  split the source in lines
  add line numbers tracing instructions so we can track which ones have been run
  regroup the lines into a single string again</p>             </td>             <td class="code">               <div class="highlight"><pre>    elaboratedSourceByLine = <span class="literal">undefined</span>
    iteratingOverSource = <span class="literal">undefined</span>
    <span class="keyword">if</span> code.indexOf(<span class="string">"doOnce"</span>) &gt; -<span class="number">1</span>
      
</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>alert("a doOnce is potentially executable");</p>             </td>             <td class="code">               <div class="highlight"><pre>      elaboratedSourceByLine = code.split(<span class="string">"\n"</span>)
      
</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>alert('splitting: ' + elaboratedSourceByLine.length );</p>             </td>             <td class="code">               <div class="highlight"><pre>      iteratingOverSource = <span class="number">0</span>
      <span class="keyword">while</span> iteratingOverSource &lt; elaboratedSourceByLine.length
        
</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>alert('iterating: ' + iteratingOverSource );</p>             </td>             <td class="code">               <div class="highlight"><pre>        
</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>add the line number tracing instruction to inline case</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSourceByLine[iteratingOverSource] =
          elaboratedSourceByLine[iteratingOverSource].replace(
            <span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*(.+)$/g</span>,
            <span class="string">"$1;addDoOnce("</span> + iteratingOverSource + <span class="string">"); (1+0).times -&gt; $2"</span>)
        
</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>add the line number tracing instruction to multiline case</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="keyword">if</span> elaboratedSourceByLine[iteratingOverSource].match(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/g</span>)
          
</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>alert('doOnce multiline!');</p>             </td>             <td class="code">               <div class="highlight"><pre>          elaboratedSourceByLine[iteratingOverSource] =
            elaboratedSourceByLine[iteratingOverSource].replace(
              <span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/g</span>, <span class="string">"$1(1+0).times -&gt;"</span>)
          elaboratedSourceByLine[iteratingOverSource + <span class="number">1</span>] =
            elaboratedSourceByLine[iteratingOverSource + <span class="number">1</span>].replace(
              <span class="regexp">/^(\s*)(.+)$/g</span>, <span class="string">"$1;addDoOnce("</span> + iteratingOverSource + <span class="string">"); $2"</span>)
        iteratingOverSource += <span class="number">1</span>
      code = elaboratedSourceByLine.join(<span class="string">"\n"</span>)
    
</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>alert('soon after replacing doOnces'+code);</p>             </td>             <td class="code">               <div class="highlight"><pre>    code

  doesProgramContainStringsOrComments: (code) -&gt;    
</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>make a copy of the string because we are going to
slice it in the process.</p>             </td>             <td class="code">               <div class="highlight"><pre>    copyOfcode = code
    characterBeingExamined = <span class="literal">undefined</span>
    nextCharacterBeingExamined = <span class="literal">undefined</span>
    <span class="keyword">while</span> copyOfcode.length
      characterBeingExamined = copyOfcode.charAt(<span class="number">0</span>)
      nextCharacterBeingExamined = copyOfcode.charAt(<span class="number">1</span>)
      <span class="keyword">if</span> characterBeingExamined <span class="keyword">is</span> <span class="string">"'"</span> <span class="keyword">or</span>
          characterBeingExamined <span class="keyword">is</span> <span class="string">"\""</span> <span class="keyword">or</span>
          (characterBeingExamined <span class="keyword">is</span> <span class="string">"/"</span> <span class="keyword">and</span>
            (nextCharacterBeingExamined <span class="keyword">is</span> <span class="string">"*"</span> <span class="keyword">or</span>
            nextCharacterBeingExamined <span class="keyword">is</span> <span class="string">"/"</span>))
        <span class="keyword">return</span> <span class="literal">true</span>
      copyOfcode = copyOfcode.slice(<span class="number">1</span>)

  stripCommentsAndCheckBasicSyntax: (code) -&gt;
    codeWithoutComments = <span class="literal">undefined</span>
    codeWithoutStringsOrComments = <span class="literal">undefined</span>
    
</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>check whether the program potentially
contains strings or comments
if it doesn't then we can do some
simple syntactic checks that are likely
to be much faster than attempting a
coffescript to javascript translation</p>             </td>             <td class="code">               <div class="highlight"><pre>    
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>let's do a quick check:
these groups of characters should be in even number:
", ', (), {}, []
Note that this doesn't check nesting, so for example
[{]} does pass the test.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">if</span> <span class="property">@doesProgramContainStringsOrComments</span>(code)
      
</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>OK the program contains comments and/or strings
so this is what we are going to do:
first we remove all the comments for good
then we create a version without the strings
so we can perform some basic syntax checking.
Note that when we remove the comments we also need to
take into account strings because otherwise we mangle a line like
print "frame/100 //"
where we need to now that that single comment is actually the content
of a string.
modified from Processing.js (search for: "masks strings and regexs")
this is useful to remove all comments but keeping all the strings
the difference is that here I don't treat regular expressions.
Note that string take precedence over comments i.e.
is a string, not half a string with a quote in a comment
get rid of the comments for good.
note the use of coffeescripts' "block regular expressions" here, and note that
there is no need to escape "/" with "\/",
see https://github.com/jashkenas/coffee-script/issues/2358</p>             </td>             <td class="code">               <div class="highlight"><pre>      code = code.replace(
        <span class="regexp">///
        ("(?:[^"\\\n]|\\.)*")|
        ('(?:[^'\\\n]|\\.)*')|
        (//[^\n]*\n)|
        (/\*(?:(?!\*/)(?:.|\n))*\*/)
        ///</span>g,
          (all, quoted, aposed, singleComment, comment) -&gt;
            numberOfLinesInMultilineComment = <span class="literal">undefined</span>
            rebuiltNewLines = <span class="literal">undefined</span>
            cycleToRebuildNewLines = <span class="literal">undefined</span>
            
</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>strings are kept as they are</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="keyword">return</span> quoted  <span class="keyword">if</span> quoted
            <span class="keyword">return</span> aposed  <span class="keyword">if</span> aposed
            
</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>preserve the line because
the doOnce mechanism needs to retrieve
the line where it was</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="keyword">return</span> <span class="string">"\n"</span>  <span class="keyword">if</span> singleComment
            
</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>eliminate multiline comments preserving the lines</p>             </td>             <td class="code">               <div class="highlight"><pre>            numberOfLinesInMultilineComment = comment.split(<span class="string">"\n"</span>).length - <span class="number">1</span>
            rebuiltNewLines = <span class="string">""</span>
            cycleToRebuildNewLines = <span class="number">0</span>
            <span class="keyword">while</span> cycleToRebuildNewLines &lt; numberOfLinesInMultilineComment
              rebuiltNewLines = rebuiltNewLines + <span class="string">"\n"</span>
              cycleToRebuildNewLines += <span class="number">1</span>
            rebuiltNewLines
      )
      codeWithoutComments = code
      
</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>ok now in the version we use for syntax checking we delete all the strings</p>             </td>             <td class="code">               <div class="highlight"><pre>      codeWithoutStringsOrComments =
        code.replace(<span class="regexp">/("(?:[^"\\\n]|\\.)*")|('(?:[^'\\\n]|\\.)*')/g</span>, <span class="string">""</span>)
    <span class="keyword">else</span>
      codeWithoutStringsOrComments = code
    aposCount = <span class="number">0</span>
    quoteCount = <span class="number">0</span>
    roundBrackCount = <span class="number">0</span>
    curlyBrackCount = <span class="number">0</span>
    squareBrackCount = <span class="number">0</span>
    characterBeingExamined = <span class="literal">undefined</span>
    reasonOfBasicError = <span class="literal">undefined</span>
    <span class="keyword">while</span> codeWithoutStringsOrComments.length
      characterBeingExamined = codeWithoutStringsOrComments.charAt(<span class="number">0</span>)
      <span class="keyword">if</span> characterBeingExamined <span class="keyword">is</span> <span class="string">"'"</span>
        aposCount += <span class="number">1</span>
      <span class="keyword">else</span> <span class="keyword">if</span> characterBeingExamined <span class="keyword">is</span> <span class="string">"\""</span>
        quoteCount += <span class="number">1</span>
      <span class="keyword">else</span> <span class="keyword">if</span> characterBeingExamined <span class="keyword">is</span> <span class="string">"("</span> <span class="keyword">or</span> characterBeingExamined <span class="keyword">is</span> <span class="string">")"</span>
        roundBrackCount += <span class="number">1</span>
      <span class="keyword">else</span> <span class="keyword">if</span> characterBeingExamined <span class="keyword">is</span> <span class="string">"{"</span> <span class="keyword">or</span> characterBeingExamined <span class="keyword">is</span> <span class="string">"}"</span>
        curlyBrackCount += <span class="number">1</span>
      <span class="keyword">else</span> <span class="keyword">if</span> characterBeingExamined <span class="keyword">is</span> <span class="string">"["</span> <span class="keyword">or</span> characterBeingExamined <span class="keyword">is</span> <span class="string">"]"</span>
        squareBrackCount += <span class="number">1</span>
      codeWithoutStringsOrComments = codeWithoutStringsOrComments.slice(<span class="number">1</span>)
    
</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>according to jsperf, the fastest way to check if number is even/odd</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">if</span> aposCount &amp; <span class="number">1</span> <span class="keyword">or</span> quoteCount &amp; <span class="number">1</span> <span class="keyword">or</span> roundBrackCount &amp; <span class="number">1</span> <span class="keyword">or</span>
        curlyBrackCount &amp; <span class="number">1</span> <span class="keyword">or</span> squareBrackCount &amp; <span class="number">1</span>
      programHasBasicError = <span class="literal">true</span>
      reasonOfBasicError = <span class="string">"Missing '"</span>  <span class="keyword">if</span> aposCount &amp; <span class="number">1</span>
      reasonOfBasicError = <span class="string">"Missing \""</span>  <span class="keyword">if</span> quoteCount &amp; <span class="number">1</span>
      reasonOfBasicError = <span class="string">"Unbalanced ()"</span>  <span class="keyword">if</span> roundBrackCount &amp; <span class="number">1</span>
      reasonOfBasicError = <span class="string">"Unbalanced {}"</span>  <span class="keyword">if</span> curlyBrackCount &amp; <span class="number">1</span>
      reasonOfBasicError = <span class="string">"Unbalanced []"</span>  <span class="keyword">if</span> squareBrackCount &amp; <span class="number">1</span>
      <span class="property">@eventRouter</span>.trigger <span class="string">"compile-time-error-thrown"</span>, reasonOfBasicError
      <span class="keyword">return</span> <span class="literal">null</span>
    
</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>no comments or strings were found, just return the same string
that was passed</p>             </td>             <td class="code">               <div class="highlight"><pre>    code

</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>  Some <span class="keyword">of</span> the functions can be used <span class="reserved">with</span> postfix notation
  
  e.g.
  
  <span class="number">60</span> bpm
  red fill
  yellow stroke
  black background
  
  We need to <span class="keyword">switch</span> <span class="keyword">this</span> round before coffee script compilation
</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>  adjustPostfixNotations: (code) -&gt;
    elaboratedSource = <span class="literal">undefined</span>
    elaboratedSource = code.replace(<span class="regexp">/(\d+)[ ]+bpm(\s)/g</span>, <span class="string">"bpm $1$2"</span>)
    elaboratedSource = elaboratedSource.replace(<span class="regexp">/([a-zA-Z]+)[ ]+fill(\s)/g</span>, <span class="string">"fill $1$2"</span>)
    elaboratedSource = elaboratedSource.replace(
      <span class="regexp">/([a-zA-Z]+)[ ]+stroke(\s)/g</span>, <span class="string">"stroke $1$2"</span>)
    elaboratedSource = elaboratedSource.replace(
      <span class="regexp">/([a-zA-Z]+)[ ]+background(\s)/g</span>, <span class="string">"background $1$2"</span>)
    elaboratedSource

  updateCode: (code) -&gt;
  	elaboratedSource = <span class="literal">undefined</span>
  	errResults = <span class="literal">undefined</span>
  	characterBeingExamined = <span class="literal">undefined</span>
  	nextCharacterBeingExamined = <span class="literal">undefined</span>
  	aposCount = <span class="literal">undefined</span>
  	quoteCount = <span class="literal">undefined</span>
  	roundBrackCount = <span class="literal">undefined</span>
  	curlyBrackCount = <span class="literal">undefined</span>
  	squareBrackCount = <span class="literal">undefined</span>
  	elaboratedSourceByLine = <span class="literal">undefined</span>
  	iteratingOverSource = <span class="literal">undefined</span>
  	reasonOfBasicError = <span class="literal">undefined</span>
  	<span class="property">@currentCodeString</span> = code
  	<span class="keyword">if</span> <span class="property">@currentCodeString</span> <span class="keyword">is</span> <span class="string">""</span>
      <span class="property">@liveCodeLabCoreInstance</span>.graphicsCommands.resetTheSpinThingy = <span class="literal">true</span>
      programHasBasicError = <span class="literal">false</span>
      <span class="property">@eventRouter</span>.trigger <span class="string">"clear-error"</span>
      <span class="property">@liveCodeLabCoreInstance</span>.drawFunctionRunner.consecutiveFramesWithoutRunTimeError = <span class="number">0</span>
      functionFromCompiledCode = <span class="keyword">new</span> Function(<span class="string">""</span>)
      <span class="property">@liveCodeLabCoreInstance</span>.drawFunctionRunner.setDrawFunction <span class="literal">null</span>
      <span class="property">@liveCodeLabCoreInstance</span>.drawFunctionRunner.lastStableDrawFunction = <span class="literal">null</span>
      <span class="keyword">return</span> functionFromCompiledCode
  	code = <span class="property">@removeTickedDoOnce</span>(code)
  	
</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>////////////////// Newer code checks</p>

<h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>  	The CodeChecker will check <span class="keyword">for</span> unbalanced brackets
  	<span class="keyword">and</span> unfinished strings
  	
  	If any errors are found <span class="keyword">then</span> we quit compilation here
  	<span class="keyword">and</span> display an error message
</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>  	
</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>errResults = CodeChecker.parse(code);</p>

<p>if (errResults.err === true) {
    @eventRouter.trigger('compile-time-error-thrown', errResults.message);
    return;
}</p>

<p>elaboratedSource = code;
elaboratedSource = preprocessingFunctions.adjustPostfixNotations(elaboratedSource);
elaboratedSource = preprocessingFunctions.fixTimesFunctions(elaboratedSource);
elaboratedSource = preprocessingFunctions.addDoOnceTracing(elaboratedSource);</p>             </td>             <td class="code">               <div class="highlight"><pre>  	
</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  	
</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>//////////////// Older code checks</p>             </td>             <td class="code">               <div class="highlight"><pre>  	
  	code = <span class="property">@stripCommentsAndCheckBasicSyntax</span>(code)
  	<span class="keyword">return</span> <span class="keyword">if</span> code <span class="keyword">is</span> <span class="literal">null</span>
  	elaboratedSource = code
  	
</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>we make it so some common command forms can be used in postfix notation, e.g.
  60 bpm
  red fill
  yellow stroke
  black background</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = <span class="property">@adjustPostfixNotations</span>(code);
  	
</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>little trick. This is mangled up in the translation from coffeescript
(1).times ->
But this isn't:
(1+0).times ->
So here is the little replace.
TODO: you should be a little smarter about the substitution of the draw method
You can tell a method declaration because the line below is indented
so you should check that.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	
</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>code =  code.replace(
  /^([a-z]+[a-zA-Z0-9]+)\s*$/gm, "$1 = ->" );
some replacements add a semicolon for the
following reason: coffeescript allows you to split arguments
over multiple lines.
So if you have:
  rotate 0,0,1
  box
and you want to add a scale like so:
  scale 2,2,2
  rotate 0,0,1
  box
What happens is that as you are in the middle of typing:
  scale 2,
  rotate 0,0,1
  box
coffeescript takes the rotate as the second argument of scale
causing mayhem.
Instead, all is good if rotate is prepended with a semicolon.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code =
  	  code.replace(<span class="regexp">/(\d+)\s+times[ ]*\-&gt;/g</span>, <span class="string">";( $1 + 0).times -&gt;"</span>)
  	code =
  	  <span class="property">@addTracingInstructionsToDoOnceBlocks</span>(code)
  	
</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>adding () to single tokens left on their own</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code =
  	  code.replace(<span class="regexp">/^(\s*)([a-z]+[a-zA-Z0-9]*)[ ]*$/gm</span>, <span class="string">"$1;$2()"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>this takes care of when a token that it's supposed to be
a function is inlined with something else e.g.
doOnce frame = 0; box
2 times -> box</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code =
  	  code.replace(<span class="regexp">/;\s*([a-z]+[a-zA-Z0-9]*)[ ]*([;\n]+)/g</span>, <span class="string">";$1()$2"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>this takes care of when a token that it's supposed to be
a function is inlined like so:
2 times -> box</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code =
  	  code.replace(<span class="regexp">/\-&gt;\s*([a-z]+[a-zA-Z0-9]*)[ ]*([;\n]+)/g</span>, <span class="string">";$1()$2"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>draw() could just be called by mistake and it's likely
to be disastrous. User doesn't even have visibility of such method,
why should he/she call it?
TODO: call draw() something else that the user is not
likely to use by mistake and take away this check.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	<span class="keyword">if</span> code.match(<span class="regexp">/[\s\+\;]+draw\s*\(/</span>) <span class="keyword">or</span> <span class="literal">false</span>
      programHasBasicError = <span class="literal">true</span>
      <span class="property">@eventRouter</span>.trigger <span class="string">"compile-time-error-thrown"</span>, <span class="string">"You can't call draw()"</span>
      <span class="keyword">return</span>
  	
</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>we don't want if and for to undergo the same tratment as, say, box
so put those back to normal.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/;(if)\(\)/g</span>, <span class="string">";$1"</span>)
  	code = code.replace(<span class="regexp">/;(else)\(\)/g</span>, <span class="string">";$1"</span>)
  	code = code.replace(<span class="regexp">/;(for)\(\)/g</span>, <span class="string">";$1"</span>)
  	code = code.replace(<span class="regexp">/\/\//g</span>, <span class="string">"#"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Why do we have to match a non-digit non-letter?
because we have to make sure that the keyword is "on its own"
otherwise for example we interfere the replacements of "background" and "round"
Checking whether the keyword is "on its own" avoid those interferences.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(scale)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(rotate)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(move)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(rect)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(line)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(bpm)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(play)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(pushMatrix)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(popMatrix)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(resetMatrix)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(fill)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(noFill)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(stroke)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(noStroke)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(strokeSize)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(animationStyle)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(simpleGradient)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(background)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(colorMode)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(color)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>code =  code.replace(/([^a-zA-Z0-9])(ambient)(\s)+/g, "$1;$2$3" );
code =  code.replace(/([^a-zA-Z0-9])(reflect)(\s)+/g, "$1;$2$3" );
code =  code.replace(/([^a-zA-Z0-9])(refract)(\s)+/g, "$1;$2$3" );</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(lights)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(noLights)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(ambientLight)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(pointLight)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(ball)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(ballDetail)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(peg)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Calculation</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(abs)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(ceil)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(constrain)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(dist)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(exp)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(floor)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(lerp)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(log)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(mag)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(map)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(max)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(min)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(norm)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(pow)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(round)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(sq)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(sqrt)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Trigonometry</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(acos)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(asin)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(atan)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(atan2)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(cos)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(degrees)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(radians)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(sin)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(tan)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Random</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(random)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(randomSeed)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(noise)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(noiseDetail)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	code = code.replace(<span class="regexp">/([^a-zA-Z0-9])(noiseSeed)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>you'd think that semicolons are OK anywhere before any command
but coffee-script doesn't like some particular configurations - fixing those:
the semicolon mangles the first line of the function definitions:</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/-&gt;(\s+);/g</span>, <span class="string">"-&gt;$1"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>the semicolon mangles the first line of if statements</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/(\sif\s*.*\s*);/g</span>, <span class="string">"$1"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>the semicolon mangles the first line of else if statements</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/(\s);(else\s*if\s*.*\s*);/g</span>, <span class="string">"$1$2"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>the semicolon mangles the first line of else statements</p>             </td>             <td class="code">               <div class="highlight"><pre>  	code = code.replace(<span class="regexp">/(\s);(else.*\s*);/g</span>, <span class="string">"$1$2"</span>)
  	<span class="keyword">try</span>
      compiledOutput = <span class="property">@CoffeeCompiler</span>.compile(code,
      	bare: <span class="string">"on"</span>
      )
  	<span class="keyword">catch</span> e
</pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>coffescript compiler has caught a syntax error.
we are going to display the error and we WON'T register
the new code</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="property">@eventRouter</span>.trigger <span class="string">"compile-time-error-thrown"</span>, e
      <span class="keyword">return</span>
</pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>alert compiledOutput</p>             </td>             <td class="code">               <div class="highlight"><pre>  	programHasBasicError = <span class="literal">false</span>
  	<span class="property">@eventRouter</span>.trigger <span class="string">"clear-error"</span>
  	
</pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>see here for the deepest examination ever of "eval"
http://perfectionkills.com/global-eval-what-are-the-options/
note that exceptions are caught by the window.onerror callback</p>             </td>             <td class="code">               <div class="highlight"><pre>  	<span class="property">@liveCodeLabCoreInstance</span>.drawFunctionRunner.consecutiveFramesWithoutRunTimeError = <span class="number">0</span>
  	
</pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>You might want to change the frame count from the program
just like you can in Processing, but it turns out that when
you ASSIGN a value to the frame variable inside
the coffeescript code, the coffeescript to javascript translator
declares a <em>local</em> frame variable, so changes to the frame
count get lost from one frame to the next.
TODO: There must be a way to tell coffeescript to accept
some variables as global, for the time being let's put
the cheap hack in place i.e. remove any local declaration that the
coffeescript to javascript translator inserts.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	compiledOutput = compiledOutput.replace(<span class="regexp">/var frame/</span>, <span class="string">";"</span>)
  	functionFromCompiledCode = <span class="keyword">new</span> Function(compiledOutput)
  	<span class="property">@liveCodeLabCoreInstance</span>.drawFunctionRunner.setDrawFunction functionFromCompiledCode
  	functionFromCompiledCode

</pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>this function is used externally after the code has been
run, so we need to attach it to the CodeTransformer object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  addCheckMarksAndUpdateCodeAndNotifyChange: \
      (CodeTransformer, doOnceOccurrencesLineNumbers) -&gt;
  	elaboratedSource = <span class="literal">undefined</span>
  	elaboratedSourceByLine = <span class="literal">undefined</span>
  	iteratingOverSource = <span class="literal">undefined</span>
  	drawFunction = <span class="literal">undefined</span>
  	
</pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>if we are here, the following has happened: someone has added an element
to the doOnceOccurrencesLineNumbers array. This can only have happened
when a doOnce block is run, because we manipulate each doOnce block
so that in its first line the line number of the block is pushed into
the doOnceOccurrencesLineNumbers array.
So, the doOnceOccurrencesLineNumbers array contains all and only the lines
of each doOnce block that has been run. Which could be more than one, because
when we start the program we could have more than one doOnce that has
to run.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	elaboratedSource = <span class="property">@currentCodeString</span>
  	
</pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>we know the line number of each doOnce block that has been run
so we go there and add a tick next to each doOnce to indicate
that it has been run.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	elaboratedSourceByLine = elaboratedSource.split(<span class="string">"\n"</span>)
  	iteratingOverSource = <span class="number">0</span>
  	<span class="keyword">while</span> iteratingOverSource &lt; doOnceOccurrencesLineNumbers.length
      elaboratedSourceByLine[doOnceOccurrencesLineNumbers[iteratingOverSource]] =
        elaboratedSourceByLine[doOnceOccurrencesLineNumbers[iteratingOverSource]].replace(
          <span class="regexp">/^(\s*)doOnce([ ]*\-&gt;[ ]*.*)$/gm</span>, <span class="string">"$1✓doOnce$2"</span>)
      iteratingOverSource += <span class="number">1</span>
  	elaboratedSource = elaboratedSourceByLine.join(<span class="string">"\n"</span>)
  	
</pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>puts the new code (where the doOnce that have been executed have
tickboxes put back) in the editor. Which will trigger a re-registration
of the new code.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	<span class="property">@eventRouter</span>.trigger <span class="string">"code-updated-by-livecodelab"</span>, elaboratedSource
</pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>alert elaboratedSource
we want to avoid that another frame is run with the old
code, as this would mean that the
runOnce code is run more than once,
so we need to register the new code.
TODO: ideally we don't want to register the
new code by getting the code from codemirror again
because we don't know what that entails. We should
just pass the code we already have.
Also updateCode() may split the source code by line, so we can
avoid that since we've just split it, we could pass
the already split code.</p>             </td>             <td class="code">               <div class="highlight"><pre>  	drawFunction = <span class="property">@updateCode</span>(elaboratedSource)
  	drawFunction

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 