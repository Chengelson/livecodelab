<!DOCTYPE html>  <html> <head>   <title>init-threejs.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-loop.html">                 animation-loop.coffee               </a>                                           <a class="source" href="background-painting.html">                 background-painting.coffee               </a>                                           <a class="source" href="big-cursor-animation.html">                 big-cursor-animation.coffee               </a>                                           <a class="source" href="blend-style.html">                 blend-style.coffee               </a>                                           <a class="source" href="code-transformations.html">                 code-transformations.coffee               </a>                                           <a class="source" href="colour-definitions.html">                 colour-definitions.coffee               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.coffee               </a>                                           <a class="source" href="demos-and-tutorials.html">                 demos-and-tutorials.coffee               </a>                                           <a class="source" href="draw-function-runner.html">                 draw-function-runner.coffee               </a>                                           <a class="source" href="events.html">                 events.coffee               </a>                                           <a class="source" href="globals.html">                 globals.coffee               </a>                                           <a class="source" href="graphic-primitives.html">                 graphic-primitives.coffee               </a>                                           <a class="source" href="init-threejs.html">                 init-threejs.coffee               </a>                                           <a class="source" href="init.html">                 init.coffee               </a>                                           <a class="source" href="lights-functions.html">                 lights-functions.coffee               </a>                                           <a class="source" href="livecodelab-core.html">                 livecodelab-core.coffee               </a>                                           <a class="source" href="math.html">                 math.coffee               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.coffee               </a>                                           <a class="source" href="renderer.html">                 renderer.coffee               </a>                                           <a class="source" href="simple-error-checker.html">                 simple-error-checker.coffee               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.coffee               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.coffee               </a>                                           <a class="source" href="ui.html">                 ui.coffee               </a>                                           <a class="source" href="url-router.html">                 url-router.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               init-threejs.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>jslint browser: true, devel: true </p>             </td>             <td class="code">               <div class="highlight"><pre>
createThreeJsSystem = ( \
    Detector, \
	  THREEx, \
	  blendedThreeJsSceneCanvas, \
	  forceCanvasRenderer, \
	  testMode, \
	  liveCodeLabCore_THREE ) -&gt;

  <span class="string">"use strict"</span>
  ThreeJsSystem = {}
  pointLight = <span class="literal">undefined</span>
  ThreeJsSystem.isWebGLUsed = <span class="literal">false</span>
  ThreeJsSystem.composer = {}
  ThreeJsSystem.forceCanvasRenderer = forceCanvasRenderer
  
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>if we've not been passed a canvas, then create a new one and make it
as big as the browser window content.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="keyword">unless</span> blendedThreeJsSceneCanvas
    blendedThreeJsSceneCanvas = document.createElement(<span class="string">"canvas"</span>)
    blendedThreeJsSceneCanvas.width = window.innerWidth
    blendedThreeJsSceneCanvas.height = window.innerHeight

  ThreeJsSystem.blendedThreeJsSceneCanvas = blendedThreeJsSceneCanvas

  <span class="keyword">if</span> <span class="keyword">not</span> ThreeJsSystem.forceCanvasRenderer <span class="keyword">and</span> Detector.webgl    
</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Webgl init.
We allow for a bigger ball detail. <br />
Also the WebGL context allows us to use the Three JS composer and the
postprocessing effects, which use shaders.</p>             </td>             <td class="code">               <div class="highlight"><pre>    ThreeJsSystem.ballDefaultDetLevel = <span class="number">16</span>
    ThreeJsSystem.blendedThreeJsSceneCanvasContext =
      blendedThreeJsSceneCanvas.getContext(<span class="string">"experimental-webgl"</span>)
    
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>see http://mrdoob.github.com/three.js/docs/53/#Reference/Renderers/WebGLRenderer</p>             </td>             <td class="code">               <div class="highlight"><pre>    ThreeJsSystem.renderer = <span class="keyword">new</span> liveCodeLabCore_THREE.WebGLRenderer(
      canvas: ThreeJsSystem.blendedThreeJsSceneCanvas
      preserveDrawingBuffer: testMode <span class="comment"># to allow screenshot</span>
      antialias: <span class="literal">false</span>
      premultipliedAlpha: <span class="literal">false</span>
    )
    ThreeJsSystem.isWebGLUsed = <span class="literal">true</span>

  <span class="keyword">else</span>    
</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Canvas init.
Note that the canvas init requires two extra canvases in order to achieve
the motion blur (as we need to keep the previous frame). Basically we have
to do manually what the WebGL solution achieves through the Three.js composer
and postprocessing/shaders.</p>             </td>             <td class="code">               <div class="highlight"><pre>    ThreeJsSystem.ballDefaultDetLevel = <span class="number">6</span>
    ThreeJsSystem.currentFrameThreeJsSceneCanvas = document.createElement(<span class="string">"canvas"</span>)
    
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>some shorthands</p>             </td>             <td class="code">               <div class="highlight"><pre>    currentFrameThreeJsSceneCanvas = ThreeJsSystem.currentFrameThreeJsSceneCanvas
    
    currentFrameThreeJsSceneCanvas.width = ThreeJsSystem.blendedThreeJsSceneCanvas.width
    currentFrameThreeJsSceneCanvas.height = ThreeJsSystem.blendedThreeJsSceneCanvas.height

    ThreeJsSystem.currentFrameThreeJsSceneCanvasContext =
      currentFrameThreeJsSceneCanvas.getContext(<span class="string">"2d"</span>)

    ThreeJsSystem.previousFrameThreeJSSceneRenderForBlendingCanvas =
      document.createElement(<span class="string">"canvas"</span>)
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>some shorthands</p>             </td>             <td class="code">               <div class="highlight"><pre>    previousFrameThreeJSSceneRenderForBlendingCanvas =
      ThreeJsSystem.previousFrameThreeJSSceneRenderForBlendingCanvas
    previousFrameThreeJSSceneRenderForBlendingCanvas.width =
      ThreeJsSystem.blendedThreeJsSceneCanvas.width
    previousFrameThreeJSSceneRenderForBlendingCanvas.height =
      ThreeJsSystem.blendedThreeJsSceneCanvas.height

    ThreeJsSystem.previousFrameThreeJSSceneRenderForBlendingCanvasContext =
      ThreeJsSystem.previousFrameThreeJSSceneRenderForBlendingCanvas.getContext(<span class="string">"2d"</span>)
    ThreeJsSystem.blendedThreeJsSceneCanvasContext =
      ThreeJsSystem.blendedThreeJsSceneCanvas.getContext(<span class="string">"2d"</span>)
    
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>see http://mrdoob.github.com/three.js/docs/53/#Reference/Renderers/CanvasRenderer</p>             </td>             <td class="code">               <div class="highlight"><pre>    ThreeJsSystem.renderer = <span class="keyword">new</span> liveCodeLabCore_THREE.CanvasRenderer(
      canvas: currentFrameThreeJsSceneCanvas
      antialias: <span class="literal">true</span> <span class="comment"># to get smoother output</span>
      preserveDrawingBuffer: testMode <span class="comment"># to allow screenshot</span>
    )

  ThreeJsSystem.renderer.setSize ThreeJsSystem.blendedThreeJsSceneCanvas.width, \
    ThreeJsSystem.blendedThreeJsSceneCanvas.height
  ThreeJsSystem.scene = <span class="keyword">new</span> liveCodeLabCore_THREE.Scene()
  ThreeJsSystem.scene.matrixAutoUpdate = <span class="literal">false</span>
  
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>put a camera in the scene</p>             </td>             <td class="code">               <div class="highlight"><pre>  ThreeJsSystem.camera = <span class="keyword">new</span> liveCodeLabCore_THREE.PerspectiveCamera(<span class="number">35</span>, \
    ThreeJsSystem.blendedThreeJsSceneCanvas.width / \
    ThreeJsSystem.blendedThreeJsSceneCanvas.height, <span class="number">1</span>, <span class="number">10000</span>)
  ThreeJsSystem.camera.position.set <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>
  ThreeJsSystem.scene.add ThreeJsSystem.camera
  
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>transparently support window resize</p>             </td>             <td class="code">               <div class="highlight"><pre>  THREEx.WindowResize.bind ThreeJsSystem.renderer, ThreeJsSystem.camera
  ThreeJsSystem.<span class="function"><span class="title">buildPostprocessingChain</span></span> = -&gt;
    renderTargetParameters = <span class="literal">undefined</span>
    renderTarget = <span class="literal">undefined</span>
    effectSaveTarget = <span class="literal">undefined</span>
    fxaaPass = <span class="literal">undefined</span>
    screenPass = <span class="literal">undefined</span>
    renderModel = <span class="literal">undefined</span>
    renderTargetParameters =
      format: liveCodeLabCore_THREE.RGBAFormat
      stencilBuffer: <span class="literal">true</span>

    renderTarget = <span class="keyword">new</span> liveCodeLabCore_THREE.WebGLRenderTarget(
      ThreeJsSystem.blendedThreeJsSceneCanvas.width,
      ThreeJsSystem.blendedThreeJsSceneCanvas.height,
      renderTargetParameters)
    effectSaveTarget = <span class="keyword">new</span> liveCodeLabCore_THREE.SavePass(
      <span class="keyword">new</span> liveCodeLabCore_THREE.WebGLRenderTarget(
        ThreeJsSystem.blendedThreeJsSceneCanvas.width,
        ThreeJsSystem.blendedThreeJsSceneCanvas.height,
        renderTargetParameters
      )
    )
    effectSaveTarget.clear = <span class="literal">false</span>
    
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Uncomment the three lines containing "fxaaPass" below to try a fast
antialiasing filter. Commented below because of two reasons: a) it's slow
b) it blends in some black pixels, so it only looks good in dark backgrounds
The problem of blending with black pixels is the same problem of the
motionBlur leaving a black trail - tracked in github with
https://github.com/davidedc/livecodelab/issues/22</p>             </td>             <td class="code">               <div class="highlight"><pre>    
</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>fxaaPass = new liveCodeLabCore<em>THREE.ShaderPass(liveCodeLabCore</em>THREE.ShaderExtras.fxaa);
fxaaPass.uniforms.resolution.value.set(1 / window.innerWidth, 1 / window.innerHeight);</p>             </td>             <td class="code">               <div class="highlight"><pre>    ThreeJsSystem.effectBlend = <span class="keyword">new</span> liveCodeLabCore_THREE.ShaderPass(
      liveCodeLabCore_THREE.ShaderExtras.blend, <span class="string">"tDiffuse1"</span>)
    screenPass = <span class="keyword">new</span> liveCodeLabCore_THREE.ShaderPass(
      liveCodeLabCore_THREE.ShaderExtras.screen)
    
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>motion blur</p>             </td>             <td class="code">               <div class="highlight"><pre>    ThreeJsSystem.effectBlend.uniforms.tDiffuse2.value = effectSaveTarget.renderTarget
    ThreeJsSystem.effectBlend.uniforms.mixRatio.value = <span class="number">0</span>
    renderModel = <span class="keyword">new</span> liveCodeLabCore_THREE.RenderPass(
      ThreeJsSystem.scene, ThreeJsSystem.camera)
    ThreeJsSystem.composer = <span class="keyword">new</span> liveCodeLabCore_THREE.EffectComposer(
      ThreeJsSystem.renderer, renderTarget)
    ThreeJsSystem.composer.addPass renderModel
    
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>ThreeJsSystem.composer.addPass(fxaaPass);</p>             </td>             <td class="code">               <div class="highlight"><pre>    ThreeJsSystem.composer.addPass ThreeJsSystem.effectBlend
    ThreeJsSystem.composer.addPass effectSaveTarget
    ThreeJsSystem.composer.addPass screenPass
    screenPass.renderToScreen = <span class="literal">true</span>

  ThreeJsSystem.buildPostprocessingChain()  <span class="keyword">if</span> ThreeJsSystem.isWebGLUsed
  ThreeJsSystem
</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 