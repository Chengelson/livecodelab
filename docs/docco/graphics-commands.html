<!DOCTYPE html>  <html> <head>   <title>graphics-commands.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-loop.html">                 animation-loop.coffee               </a>                                           <a class="source" href="autocoder.html">                 autocoder.coffee               </a>                                           <a class="source" href="lexer.html">                 lexer.coffee               </a>                                           <a class="source" href="background-painter.html">                 background-painter.coffee               </a>                                           <a class="source" href="big-cursor.html">                 big-cursor.coffee               </a>                                           <a class="source" href="blend-controls.html">                 blend-controls.coffee               </a>                                           <a class="source" href="code-transformer.html">                 code-transformer.coffee               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.coffee               </a>                                           <a class="source" href="colour-literals.html">                 colour-literals.coffee               </a>                                           <a class="source" href="editor.html">                 editor.coffee               </a>                                           <a class="source" href="event-router.html">                 event-router.coffee               </a>                                           <a class="source" href="globals.html">                 globals.coffee               </a>                                           <a class="source" href="graphics-commands.html">                 graphics-commands.coffee               </a>                                           <a class="source" href="init.html">                 init.coffee               </a>                                           <a class="source" href="lights-commands.html">                 lights-commands.coffee               </a>                                           <a class="source" href="livecodelab-core.html">                 livecodelab-core.coffee               </a>                                           <a class="source" href="math.html">                 math.coffee               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.coffee               </a>                                           <a class="source" href="parser.html">                 parser.coffee               </a>                                           <a class="source" href="program-loader.html">                 program-loader.coffee               </a>                                           <a class="source" href="program-runner.html">                 program-runner.coffee               </a>                                           <a class="source" href="renderer.html">                 renderer.coffee               </a>                                           <a class="source" href="samplebank.html">                 samplebank.coffee               </a>                                           <a class="source" href="sound-system.html">                 sound-system.coffee               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.coffee               </a>                                           <a class="source" href="threejs-system.html">                 threejs-system.coffee               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.coffee               </a>                                           <a class="source" href="ui.html">                 ui.coffee               </a>                                           <a class="source" href="url-router.html">                 url-router.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               graphics-commands.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>jslint browser: true 
global color, lightSystem, colorModeA, redF, greenF, blueF, alphaZeroToOne  </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Please reference the colour-functions.js file for all colour-related
functions and lights-functions.js for lights, which use a similar
structure for caching and counting of light instances.</p>

<h1>Fundamentals</h1>

<p>There are a couple of fundamentals of LiveCodeLab and a couple of
complications of Three.js that shape the way
graphic primitives work in this file.</p>

<h2>LiveCodeLab uses immediate mode graphics</h2>

<p>First off, like Processing, LiveCodeLab shies away from "retained" graphics
and instead uses "immediate mode" graphics.
For context, "immediate mode" graphics means that when the user uses a graphic
primitive, he is
NOT given a handle that he can use to modify properties of that element at a
later stage, contrarily to flash, DOM, CSS, openGL and Three.JS
(to different degrees).
Retained graphic modes keep structures in memory that make easy for example
to do event handling (which object did I click?), hierarchy management
(parent/child relationships, container/content, etc), property tweaking
(change property X of object Y), and sometimes animation ( CoreAnimation from
Apple for example), collision/overlap detection. Note that openGL is retained
in that there are handles to geometry and textures, but little else is given
(no events, no input, no physics/overlap/collision/animation).
Also, retained graphics mode usually is smart about updating
only minimal parts of the screen that need updating rather than redrawing the
whole screen (again, openGL doesn't do that apart from basic frustum culling, but
for example there is nothing to detect occlusions and avoid painting occluded
objects).
There are a few drawbacks in retained modes: a) programs that manage
handles are more lengthy than programs that don't
b) they are often not needed for example in
2d sprites-based videogames c) most importantly,
they require deeper understanding of the underlying
model (e.g. which property can I change? What are those called? How do I change
parent/child relationship? How do events bubble up and where should I catch them?).
Processing and LiveCodeLab go for immediate mode. Once the primitive is invoked, it
becomes pixels and there is no built-in way to do input/event/hierarchies...
Rather, there are a few properties that are set as a global state and apply to all
objects. Examples are "fill" and "stroke".</p>

<h2>Relationship between objects, meshes, geometry, materials...</h2>

<p>A Three.js object (or to be more precise, Object3D) can be a line or a mesh. A line
is a line, a mesh can be anything else depending on what the geometry of the mesh
is. There are more possible types such as particles, etc. but they are not currently
used in LiveCodeLab. An object needs one more thing: a material.</p>

<h2>Caching of objects</h2>

<p>Once created, objects are kept cached together with all possible materials that can be
associated with it. Each object has to have its own set of materials because
one can decide to draw one object in solid fill, one in normal color, one with
an ambient light (i.e. lambert material), etc.</p>

<h2>Objects are kept in the scene</h2>

<p>Once an object is added to the scene, it's never removed. Rather, it's hidden if it's
not used, but it's never removed. This is because adding/removing objects from the
scene is rather expensive. Note that Mr Doob mentioned via email that subsequent
versions of three.js have improved performance a lot, so it's worth trying another
approach.</p>

<h2>Strokes are managed via separate objects for stroke and fill</h2>

<p>There is a particular flag in Three.js materials for drawing wireframes. But materials
cannot be combined, i.e. only one is associated at any time with a geometry. So one
can either draw a wireframe or a fill. In previous versions of Three.js more than
one material could be associated, but that has been deprecated, see
https://github.com/mrdoob/three.js/issues/751 and instead a
createMultiMaterialObject utility was put in place, which basically creates multiple
objects one for each material, see
https://github.com/mrdoob/three.js/blob/dev/src/extras/SceneUtils.js#L29
So the solution here is to create two disting objects.
One for the fills and one, slightly "larger", for the strokes. In that way, the
strokes are visible "in front" of the fills, and the fills cover the strokes "at
the back"</p>

<h2>The order of materials matters</h2>

<p>When an object is created, it must be first rendered with the most complex material,
because internally in Three.js/WebGL memory is allocated only once. So a special
mechanism is put in place by which new objects are drawn with the normalMaterial
with scale 0, so they are rendered but they are invisible. In the next frame (i.e.
after the first render) the correct material is used.</p>

<h2>"Spinning"</h2>

<p>"Spinning" applies to all objects added to an empty frame: it makes all objects spin
for a few frames. This has been implemented for two reasons a) cosmetic b) the user
is likely to first use "box", and without spinning that would look like a boring
square that appears without animation. Spinning gives many more cues: the environment
is 3d, the lighting is special by default and all faces have primary colors, things
animate. Without spinning, all those cues need to be further explained and demonstra
ted.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">GraphicsCommands</span>
  <span class="s">&quot;use strict&quot;</span>

  <span class="nv">primitiveTypes: </span><span class="p">{}</span>
  <span class="nv">minimumBallDetail: </span><span class="mi">2</span>
  <span class="nv">maximumBallDetail: </span><span class="mi">30</span>
  <span class="nv">doFill: </span><span class="kc">true</span>
  <span class="nv">doStroke: </span><span class="kc">true</span>
  <span class="nv">reflectValue: </span><span class="mi">1</span>
  <span class="nv">refractValue: </span><span class="mf">0.98</span>
  <span class="nv">currentStrokeAlpha: </span><span class="kc">undefined</span>
  <span class="nv">currentStrokeColor: </span><span class="kc">undefined</span>
  <span class="nv">geometriesBank: </span><span class="p">[]</span>
  <span class="nv">SPIN_DURATION_IN_FRAMES: </span><span class="mi">30</span>
  <span class="nv">currentFillAlpha: </span><span class="kc">undefined</span>
  <span class="nv">currentFillColor: </span><span class="kc">undefined</span>
  <span class="nv">objectPools: </span><span class="p">[]</span>
  <span class="nv">ballDetLevel: </span><span class="mi">8</span>
  <span class="nv">currentStrokeSize: </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>For each pool we have a count of how many of those entries
are actually used in the current frame.
This is so that we can go through the scene graph and hide the unused objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">objectsUsedInFrameCounts: </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>the "spinthingy" is because we want
users who type "box" to see that it's actually
a 3d environment. So the first few primitives
spin for a few moments when they are created.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doTheSpinThingy: </span><span class="kc">true</span>
  <span class="nv">resetTheSpinThingy: </span><span class="kc">false</span>
  <span class="nv">defaultNormalFill: </span><span class="kc">true</span>
  <span class="nv">defaultNormalStroke: </span><span class="kc">true</span>
  
  <span class="nv">constructor: </span><span class="nf">(@liveCodeLabCore_three, @liveCodeLabCoreInstance) -&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">line = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@line</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">rect = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@rect</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">box = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@box</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">peg = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@peg</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">ball = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@ball</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">ballDetail = </span><span class="nf">(a) =&gt;</span> <span class="nx">@ballDetail</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">fill = </span><span class="nf">(a,b,c,d) =&gt;</span> <span class="nx">@fill</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">d</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">noFill = </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">@noFill</span><span class="p">()</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">stroke = </span><span class="nf">(a,b,c,d) =&gt;</span> <span class="nx">@stroke</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">d</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">noStroke = </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">@noStroke</span><span class="p">()</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">strokeSize = </span><span class="nf">(a) =&gt;</span> <span class="nx">@strokeSize</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
    
    <span class="vi">@primitiveTypes.ambientLight = </span><span class="mi">0</span>
    <span class="vi">@primitiveTypes.line = </span><span class="mi">1</span>
    <span class="vi">@primitiveTypes.rect = </span><span class="mi">2</span>
    <span class="vi">@primitiveTypes.box = </span><span class="mi">3</span>
    <span class="vi">@primitiveTypes.peg = </span><span class="mi">4</span>
    <span class="vi">@primitiveTypes.ball = </span><span class="mi">5</span>
    </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>apparently in Coffeescript I can't initialise fields in the section
before the constructor, so initialising them here in the constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">line</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">rect</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">box</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">peg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>creating ball pools</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">@maximumBallDetail</span> <span class="o">-</span> <span class="nx">@minimumBallDetail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
      <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">ball</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Since you can't change the geometry of an object once it's created, we keep around
a pool of objects for each mesh type. There is one pool for lines, one for rectangles,
one for boxes. There is one pool for each detail level of balls (since they are
different) meshes. For the time being there is no detail level for cylinders so there
is only one pool for cylinders.</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>For how the mechanism works now, all pooled objects end up in the scene graph.
The scene graph is traversed at each frame and only the used objects are marked as
visible, the other unused objects are hidden. This is because adding/removing
objects from the scene is expensive. Note that this might have changed with more
recent versions of Three.js of the past 4 months.</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>All object pools start empty. Note that each ball detail level must have
its own pool, because you can't change the geometry of an object.
If one doesn't like the idea of creating dozens of empty arrays that won't ever be
used (since probably only a few ball detail levels will be used in a session)
then one could leave all these arrays undefined and define them at runtime
only when needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    <span class="nx">@geometriesBank</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">line</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">()</span>
    <span class="nx">@geometriesBank</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">line</span><span class="p">].</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span> <span class="o">\</span>
      <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nx">@geometriesBank</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">line</span><span class="p">].</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span> <span class="o">\</span>
      <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nx">@geometriesBank</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">rect</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">@geometriesBank</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">box</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">CubeGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">@geometriesBank</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">peg</span><span class="p">]</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>creating ball geometries</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">@maximumBallDetail</span> <span class="o">-</span> <span class="nx">@minimumBallDetail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
      <span class="nx">@geometriesBank</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">ball</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">SphereGeometry</span><span class="p">(</span>
          <span class="mi">1</span><span class="p">,</span> <span class="nx">@minimumBallDetail</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">@minimumBallDetail</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span>
    
  
  <span class="nv">createObjectIfNeededAndDressWithCorrectMaterial: </span><span class="nf">(</span>
<span class="nf">      a, b, c, primitiveProperties, strokeTime, colorToBeUsed,</span>
<span class="nf">      alphaToBeUsed, applyDefaultNormalColor) -&gt;</span>
    <span class="nv">objectIsNew = </span><span class="kc">false</span>
    <span class="nv">pooledObjectWithMaterials = </span><span class="kc">undefined</span>
    <span class="nv">theAngle = </span><span class="kc">undefined</span>
    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>the primitiveID is used to index three arrays:
  array of caches (pools) of objects
  array of caches (pools) of geometries
  counters of how many objects of that type have been used in the current frame.
Note that primitives that have an associated detail level span across
multiple IDs, because geometries at different details levels are different.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">primitiveID = </span><span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">primitiveType</span> <span class="o">+</span> <span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">detailLevel</span>
    <span class="nv">objectPool = </span><span class="nx">@objectPools</span><span class="p">[</span><span class="nx">primitiveID</span><span class="p">]</span>
    <span class="nv">pooledObjectWithMaterials = </span><span class="nx">objectPool</span><span class="p">[</span><span class="nx">@objectsUsedInFrameCounts</span><span class="p">[</span><span class="nx">primitiveID</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nx">pooledObjectWithMaterials</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
      </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>each pooled object contains a geometry, and all the materials it could
ever need.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">pooledObjectWithMaterials =</span>
        </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The line material is specifically made for lines. So for lines
we have to simulate manually the effect that the other materials
have on the solids.
Note that we can tell here whether the lineMaterial (or all the
others) will ever be needed for this object, because as mentioned
lines will ever only have the lineMaterial for example, and cubes
won't ever have the lineMaterial, but this initialisation costs
nothing and makes the code cleaner.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">lineMaterial: </span><span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>The basic material is for simple solid fill without lighting</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">basicMaterial: </span><span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The Lambert material is for fill with lighting</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">lambertMaterial: </span><span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>The normalMaterial is the trippy fill with each side of the cube
being a bright color (the default one).
Note that the first time we render an object we need to
render it with the material that takes the
bigger buffer space, otherwise the
more complicated materials won't show
up, see:
https://github.com/mrdoob/three.js/issues/1051
so we always need to create a normal material
and render that material first, in case
the user will ever want to use it.
Another workaround would be to create an object
for each different type of material.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">normalMaterial: </span><span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        <span class="nv">threejsObject3D: </span><span class="o">\</span>
          <span class="k">new</span> <span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">threeObjectConstructor</span><span class="p">(</span><span class="nx">@geometriesBank</span><span class="p">[</span><span class="nx">primitiveID</span><span class="p">])</span>
        <span class="nv">initialSpinCountdown: </span><span class="nx">@SPIN_DURATION_IN_FRAMES</span>

      <span class="nv">objectIsNew = </span><span class="kc">true</span>
      <span class="nx">objectPool</span><span class="p">.</span><span class="nx">push</span> <span class="nx">pooledObjectWithMaterials</span>
    <span class="k">if</span> <span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">primitiveType</span> <span class="o">is</span> <span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">line</span>
      <span class="k">if</span> <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">lineMaterial</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        <span class="nv">pooledObjectWithMaterials.lineMaterial =</span>
          <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">LineBasicMaterial</span><span class="p">()</span>
      </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>associating normal material to threejs' Object3D</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@currentStrokeColor</span> <span class="o">is</span> <span class="nx">angleColor</span> <span class="o">or</span> <span class="nx">@defaultNormalStroke</span>
        <span class="nv">theAngle =</span>
          <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">threejsObject3D</span><span class="p">.</span><span class="nx">matrix</span><span class="p">.</span><span class="nx">multiplyVector3</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span><span class="nx">normalize</span><span class="p">()</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">lineMaterial</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">setHex</span> <span class="o">\</span>
          <span class="nx">color</span><span class="p">(</span>
            <span class="p">((</span><span class="nx">theAngle</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span>
            <span class="p">((</span><span class="nx">theAngle</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span>
            <span class="p">((</span><span class="nx">theAngle</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">lineMaterial</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">setHex</span> <span class="nx">@currentStrokeColor</span>
      <span class="nv">pooledObjectWithMaterials.lineMaterial.linewidth =</span>
        <span class="nx">@currentStrokeSize</span>
      <span class="nv">pooledObjectWithMaterials.threejsObject3D.material =</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">lineMaterial</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">objectIsNew</span> <span class="o">or</span> <span class="p">(</span><span class="nx">colorToBeUsed</span> <span class="o">is</span> <span class="nx">angleColor</span> <span class="o">or</span> <span class="nx">applyDefaultNormalColor</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>the first time we render a an object we need to
render it with the material that takes the
bigger buffer space, see:
https://github.com/mrdoob/three.js/issues/1051
Another workaround would be to create a pooled object
for each different type of material.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">normalMaterial</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        <span class="nv">pooledObjectWithMaterials.normalMaterial =</span>
          <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">MeshNormalMaterial</span><span class="p">()</span>
      <span class="nv">pooledObjectWithMaterials.threejsObject3D.material =</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">normalMaterial</span>
    <span class="k">else</span> <span class="k">unless</span> <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">lightSystem</span><span class="p">.</span><span class="nx">lightsAreOn</span>
      <span class="k">if</span> <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">basicMaterial</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        <span class="nv">pooledObjectWithMaterials.basicMaterial =</span>
          <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">MeshBasicMaterial</span><span class="p">()</span>
      <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">basicMaterial</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">setHex</span> <span class="nx">colorToBeUsed</span>
      <span class="nv">pooledObjectWithMaterials.threejsObject3D.material =</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">basicMaterial</span>
    <span class="k">else</span>
      </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>lights are on</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">lambertMaterial</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        <span class="nv">pooledObjectWithMaterials.lambertMaterial =</span>
          <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">MeshLambertMaterial</span><span class="p">()</span>
      <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">lambertMaterial</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">setHex</span> <span class="nx">colorToBeUsed</span>
      <span class="nv">pooledObjectWithMaterials.threejsObject3D.material =</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">lambertMaterial</span>
    </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>not all of these properties apply in all cases (for example sidedness
doesn't apply to lines), but setting these properties in those cases
has no ill effect and we are factoring out here as many initialisations
as possible to make the code cleaner.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">pooledObjectWithMaterials.threejsObject3D.material.side =</span>
      <span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">sidedness</span>
    <span class="nv">pooledObjectWithMaterials.threejsObject3D.material.opacity = </span><span class="nx">alphaToBeUsed</span>
    <span class="k">if</span> <span class="nx">alphaToBeUsed</span> <span class="o">&lt;</span> <span class="mi">1</span>
      <span class="nv">pooledObjectWithMaterials.threejsObject3D.material.transparent = </span><span class="kc">true</span>
    <span class="nv">pooledObjectWithMaterials.threejsObject3D.material.wireframe = </span><span class="nx">strokeTime</span>
    <span class="nv">pooledObjectWithMaterials.threejsObject3D.material.wireframeLinewidth =</span>
      <span class="nx">@currentStrokeSize</span>
    <span class="nv">pooledObjectWithMaterials.threejsObject3D.material.reflectivity = </span><span class="nx">@reflectValue</span>
    <span class="nv">pooledObjectWithMaterials.threejsObject3D.material.refractionRatio = </span><span class="nx">@refractValue</span>
    <span class="k">if</span> <span class="nx">@resetTheSpinThingy</span>
      <span class="nv">pooledObjectWithMaterials.initialSpinCountdown = </span><span class="nx">@SPIN_DURATION_IN_FRAMES</span>
      <span class="vi">@resetTheSpinThingy = </span><span class="kc">false</span>
      <span class="vi">@doTheSpinThingy = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">@doTheSpinThingy</span>
      <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">initialSpinCountdown</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">initialSpinCountdown</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
      <span class="vi">@doTheSpinThingy = </span><span class="kc">false</span>
    <span class="nv">pooledObjectWithMaterials.threejsObject3D.primitiveType =</span>
      <span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">primitiveType</span>
    <span class="nv">pooledObjectWithMaterials.threejsObject3D.detailLevel =</span>
      <span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">detailLevel</span>
    <span class="nx">@objectsUsedInFrameCounts</span><span class="p">[</span><span class="nx">primitiveID</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nx">@doTheSpinThingy</span> <span class="o">and</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">initialSpinCountdown</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">matrixCommands</span><span class="p">.</span><span class="nx">pushMatrix</span><span class="p">()</span>
      <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">matrixCommands</span><span class="p">.</span><span class="nx">rotate</span> <span class="o">\</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">initialSpinCountdown</span> <span class="o">/</span> <span class="mi">50</span>
    </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>see https://github.com/mrdoob/three.js/wiki/Using-Matrices-&amp;-Object3Ds-in-THREE
for info on how this works.
Around 11% of the time is spent doing matrix multiplications, which
happens every time there is a scale or rotate or move.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">pooledObjectWithMaterials.threejsObject3D.matrixAutoUpdate = </span><span class="kc">false</span>
    <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">threejsObject3D</span><span class="p">.</span><span class="nx">matrix</span><span class="p">.</span><span class="nx">copy</span> <span class="o">\</span>
      <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">matrixCommands</span><span class="p">.</span><span class="nx">getWorldMatrix</span><span class="p">()</span>
    <span class="nv">pooledObjectWithMaterials.threejsObject3D.matrixWorldNeedsUpdate = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">@doTheSpinThingy</span> <span class="o">and</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">initialSpinCountdown</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">matrixCommands</span><span class="p">.</span><span class="nx">popMatrix</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">objectIsNew</span>
      </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>if the object is new it means that the normal material
is applied to it, no matter what the current settings of fill
and lights are. So we make objects invisible in their very first
frame to avoid it flashing briefly in completely the wrong colour
by setting the scale to almost zero. The object will still go through
the rendering step, so the memory for the material is initialised
correctly.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">threejsObject3D</span><span class="p">.</span><span class="nx">matrix</span><span class="p">.</span><span class="nx">scale</span> <span class="o">\</span>
        <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">isnt</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">b</span> <span class="o">isnt</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">c</span> <span class="o">isnt</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="nx">strokeTime</span>        </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>wireframes are built via separate objects with geometries that are
ever so slight larger than the "fill" object, so there
is no z-fighting and the stroke is drawn neatly on top of the fill
constant 0.001 below is to avoid z-fighting</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">threejsObject3D</span><span class="p">.</span><span class="nx">matrix</span><span class="p">.</span><span class="nx">scale</span> <span class="o">\</span>
          <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">,</span> <span class="nx">b</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">,</span> <span class="nx">c</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">threejsObject3D</span><span class="p">.</span><span class="nx">matrix</span><span class="p">.</span><span class="nx">scale</span> <span class="o">\</span>
          <span class="k">new</span> <span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
    <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">threeJsSystem</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">add</span> <span class="o">\</span>
      <span class="nx">pooledObjectWithMaterials</span><span class="p">.</span><span class="nx">threejsObject3D</span>  <span class="k">if</span> <span class="nx">objectIsNew</span>

  <span class="nv">commonPrimitiveDrawingLogic: </span><span class="nf">(a, b, c, primitiveProperties) -&gt;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>b and c are not functional in some geometric
primitives, but we handle them here in all cases
to make the code uniform and unifiable</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
      <span class="nv">a = </span><span class="mi">1</span>
      <span class="nv">b = </span><span class="mi">1</span>
      <span class="nv">c = </span><span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">b</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
      <span class="nv">b = </span><span class="nx">a</span>
      <span class="nv">c = </span><span class="nx">a</span>
    <span class="k">else</span> <span class="nv">c = </span><span class="mi">1</span>  <span class="k">if</span> <span class="nx">c</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
    </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Simple case - if there is no fill and
no stroke then there is nothing to do.
Also, even if we aren'd under a noFill command spell, some geometries
inherently don't have a fill, so we return if there is no stroke either.
(right now that applies only lines).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span>  <span class="k">if</span> <span class="o">not</span> <span class="nx">@doStroke</span> <span class="o">and</span> <span class="p">(</span><span class="o">not</span> <span class="nx">@doFill</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">canFill</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>if we are under the influence of a noFill command OR
the wireframe is not going to be visible on top of the
fill then don't draw the stroke, only draw the fill</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">canFill</span> <span class="o">and</span> <span class="nx">@doFill</span> <span class="o">and</span> <span class="p">(</span>
        <span class="nx">@currentStrokeSize</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">@doStroke</span> <span class="o">or</span>
        <span class="p">(</span><span class="nx">@currentStrokeSize</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">and</span>
        <span class="o">not</span> <span class="nx">@defaultNormalFill</span> <span class="o">and</span>
        <span class="o">not</span> <span class="nx">@defaultNormalStroke</span> <span class="o">and</span>
        <span class="nx">@currentStrokeColor</span> <span class="o">is</span> <span class="nx">@currentFillColor</span> <span class="o">and</span>
        <span class="nx">@currentFillAlpha</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">@currentStrokeAlpha</span> <span class="o">is</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">or</span>
        <span class="p">(</span><span class="nx">@currentStrokeSize</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">and</span>
        <span class="nx">@defaultNormalFill</span> <span class="o">and</span>
        <span class="nx">@defaultNormalStroke</span><span class="p">)</span>
      <span class="nx">@createObjectIfNeededAndDressWithCorrectMaterial</span> <span class="o">\</span>
        <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">primitiveProperties</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">@currentFillColor</span><span class="p">,</span> <span class="nx">@currentFillAlpha</span><span class="p">,</span>
        <span class="nx">@defaultNormalFill</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">not</span> <span class="nx">@doFill</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">primitiveProperties</span><span class="p">.</span><span class="nx">canFill</span><span class="p">)</span> <span class="o">and</span> <span class="nx">@doStroke</span>
      </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>only doing the stroke</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@createObjectIfNeededAndDressWithCorrectMaterial</span> <span class="o">\</span>
        <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">primitiveProperties</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">@currentStrokeColor</span><span class="p">,</span> <span class="nx">@currentStrokeAlpha</span><span class="p">,</span>
        <span class="nx">@defaultNormalStroke</span>
    </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>doing both the fill and the stroke</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nx">@createObjectIfNeededAndDressWithCorrectMaterial</span> <span class="o">\</span>
        <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">primitiveProperties</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">@currentStrokeColor</span><span class="p">,</span> <span class="nx">@currentStrokeAlpha</span><span class="p">,</span>
        <span class="nx">@defaultNormalStroke</span>
      <span class="nx">@createObjectIfNeededAndDressWithCorrectMaterial</span> <span class="o">\</span>
        <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">primitiveProperties</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">@currentFillColor</span><span class="p">,</span> <span class="nx">@currentFillAlpha</span><span class="p">,</span>
        <span class="nx">@defaultNormalFill</span>

  <span class="nv">reset: </span><span class="nf">-&gt;</span>
    <span class="nx">@fill</span> <span class="mh">0xFFFFFFFF</span>
    <span class="nx">@stroke</span> <span class="mh">0xFFFFFFFF</span>
    <span class="vi">@currentStrokeSize = </span><span class="mi">1</span>
    <span class="vi">@defaultNormalFill = </span><span class="kc">true</span>
    <span class="vi">@defaultNormalStroke = </span><span class="kc">true</span>
    <span class="vi">@ballDetLevel =</span>
      <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">threeJsSystem</span><span class="p">.</span><span class="nx">ballDefaultDetLevel</span>
    <span class="nx">@objectsUsedInFrameCounts</span><span class="o">\</span>
      <span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">ambientLight</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">@objectsUsedInFrameCounts</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">line</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">@objectsUsedInFrameCounts</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">rect</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">@objectsUsedInFrameCounts</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">box</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">@objectsUsedInFrameCounts</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">peg</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>initialising ball counts</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">@maximumBallDetail</span> <span class="o">-</span> <span class="nx">@minimumBallDetail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
      <span class="nx">@objectsUsedInFrameCounts</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">ball</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

  </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>TODO Note that lines have a "solid fill" mode
and something similar to the normalMaterial mode
but there is no equivalent to the lambert material
mode.
That could be done by somehow mixing the color of
an ambient light to the color of the stroke
(although which ambient light do you pick if there
is more than one?)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">line: </span><span class="nf">(a, b, c) -&gt;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>lines can only have one material, which is LineBasicMaterial
which doesn't react to lights (as opposed to MeshLambertMaterial, which
only applies to meshes).
So in order to get lights to react to light we have to actually draw the
wireframe of a rectangle with one of the sides being zero length.
Since the stroke and the fill are drawn with two different objects and the
fill is not needed, we temporarily switch off the fill and then put it back
to whichever value it was.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">lightSystem</span><span class="p">.</span><span class="nx">lightsAreOn</span>
      <span class="nv">rememberIfThereWasAFill = </span><span class="nx">@doFill</span>
      <span class="nv">rememberPreviousStrokeSize = </span><span class="nx">@currentStrokeSize</span>
      <span class="vi">@currentStrokeSize = </span><span class="mi">2</span>  <span class="k">if</span> <span class="nx">@currentStrokeSize</span> <span class="o">&lt;</span> <span class="mi">2</span>
      <span class="nv">a = </span><span class="mi">1</span>  <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
      <span class="nx">@rect</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="mi">0</span>
      <span class="vi">@doFill = </span><span class="nx">rememberIfThereWasAFill</span>
      <span class="vi">@currentStrokeSize = </span><span class="nx">rememberPreviousStrokeSize</span>
      <span class="k">return</span>
    </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">primitiveProperties =</span>
      <span class="nv">canFill: </span><span class="kc">false</span>
      <span class="nv">primitiveType: </span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">line</span>
      <span class="nv">sidedness: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">FrontSide</span>
      <span class="nv">threeObjectConstructor: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Line</span>
      <span class="nv">detailLevel: </span><span class="mi">0</span>

    </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@commonPrimitiveDrawingLogic</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">primitiveProperties</span>

  <span class="nv">rect: </span><span class="nf">(a, b, c) -&gt;</span>    </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">primitiveProperties =</span>
      <span class="nv">canFill: </span><span class="kc">true</span>
      <span class="nv">primitiveType: </span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">rect</span>
      <span class="nv">sidedness: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">DoubleSide</span>
      <span class="nv">threeObjectConstructor: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Mesh</span>
      <span class="nv">detailLevel: </span><span class="mi">0</span>

    </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@commonPrimitiveDrawingLogic</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">primitiveProperties</span>

  <span class="nv">box: </span><span class="nf">(a, b, c) -&gt;</span>    </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">primitiveProperties =</span>
      <span class="nv">canFill: </span><span class="kc">true</span>
      <span class="nv">primitiveType: </span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">box</span>
      <span class="nv">sidedness: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">FrontSide</span>
      <span class="nv">threeObjectConstructor: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Mesh</span>
      <span class="nv">detailLevel: </span><span class="mi">0</span>

    </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@commonPrimitiveDrawingLogic</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">primitiveProperties</span>

  <span class="nv">peg: </span><span class="nf">(a, b, c) -&gt;</span>    </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">primitiveProperties =</span>
      <span class="nv">canFill: </span><span class="kc">true</span>
      <span class="nv">primitiveType: </span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">peg</span>
      <span class="nv">sidedness: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">FrontSide</span>
      <span class="nv">threeObjectConstructor: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Mesh</span>
      <span class="nv">detailLevel: </span><span class="mi">0</span>

    </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@commonPrimitiveDrawingLogic</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">primitiveProperties</span>

  <span class="nv">ballDetail: </span><span class="nf">(a) -&gt;</span>
    <span class="k">return</span>  <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
    <span class="nv">a = </span><span class="mi">2</span>  <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">2</span>
    <span class="nv">a = </span><span class="mi">30</span>  <span class="k">if</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="mi">30</span>
    <span class="vi">@ballDetLevel = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>

  <span class="nv">ball: </span><span class="nf">(a, b, c) -&gt;</span>    </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">primitiveProperties =</span>
      <span class="nv">canFill: </span><span class="kc">true</span>
      <span class="nv">primitiveType: </span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">ball</span>
      <span class="nv">sidedness: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">FrontSide</span>
      <span class="nv">threeObjectConstructor: </span><span class="nx">@liveCodeLabCore_three</span><span class="p">.</span><span class="nx">Mesh</span>
      <span class="nv">detailLevel: </span><span class="nx">@ballDetLevel</span> <span class="o">-</span> <span class="nx">@minimumBallDetail</span>

    </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@commonPrimitiveDrawingLogic</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">primitiveProperties</span>

  </pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Modified from Processing.js</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fill: </span><span class="nf">(r, g, b, a) -&gt;</span>    </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Three.js needs two integers to define an RGBA: the rgb as a 24 bit integer
and the alpha (from zero to one).
Now the thing is that the color gan be given in different
shapes:
  red, green, blue, alpha
  integerOfColor, alpha
  integerForGreyScale, alpha
  the three abobe without the alpha
So the helper functions color and alphaZeroToOne, taken from Processing.js
take care of that disambiguation.
The only complication is that there is a special color called
angleColor that is used to dress the geometries with the normal material.
So in that case, again, there are two forms of invokation
  angleColor
  angleColor, alpha</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@doFill = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">r</span> <span class="o">isnt</span> <span class="nx">angleColor</span>
      <span class="vi">@defaultNormalFill = </span><span class="kc">false</span>
      <span class="vi">@currentFillColor = </span><span class="nx">color</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
      <span class="vi">@currentFillAlpha = </span><span class="nx">alphaZeroToOne</span><span class="p">(</span><span class="nx">color</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">))</span>
    <span class="k">else</span>
      </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>we keep track of the "normal fill" flag and the fill color
separately because
we can do some smart optimisation later
and not draw the wireframe is it happens to be the same color as
the fill</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@defaultNormalFill = </span><span class="kc">true</span>
      <span class="vi">@currentFillColor = </span><span class="nx">angleColor</span>
      <span class="k">if</span> <span class="nx">b</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span> <span class="o">and</span> <span class="nx">g</span> <span class="o">isnt</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        <span class="vi">@currentFillAlpha = </span><span class="nx">g</span> <span class="o">/</span> <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">colourFunctions</span><span class="p">.</span><span class="nx">colorModeA</span>
      <span class="k">else</span>
        <span class="vi">@currentFillAlpha = </span><span class="mi">1</span>

  
  
  <span class="nx">The</span> <span class="nx">noFill</span><span class="p">()</span> <span class="nx">function</span> <span class="nx">disables</span> <span class="nx">filling</span> <span class="nx">geometry</span><span class="p">.</span>
  <span class="nx">If</span> <span class="nx">both</span> <span class="o">&lt;</span><span class="nx">b</span><span class="o">&gt;</span><span class="nx">noStroke</span><span class="p">()</span><span class="o">&lt;/</span><span class="nx">b</span><span class="o">&gt;</span> <span class="o">and</span> <span class="o">&lt;</span><span class="nx">b</span><span class="o">&gt;</span><span class="nx">noFill</span><span class="p">()</span><span class="o">&lt;/</span><span class="nx">b</span><span class="o">&gt;</span>
  <span class="nx">are</span> <span class="nx">called</span><span class="p">,</span> <span class="kc">no</span> <span class="nx">shapes</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">drawn</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">screen</span><span class="p">.</span>
  
  <span class="nx">@see</span> <span class="c1">#fill()</span>
  
  <span class="nv">noFill: </span><span class="nf">-&gt;</span>
    <span class="vi">@doFill = </span><span class="kc">false</span>
    <span class="vi">@defaultNormalFill = </span><span class="kc">false</span>

  
  
  <span class="nx">The</span> <span class="nx">stroke</span><span class="p">()</span> <span class="nx">function</span> <span class="nx">sets</span> <span class="nx">the</span> <span class="nx">color</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">draw</span> <span class="nx">lines</span> <span class="o">and</span> <span class="nx">borders</span> <span class="nx">around</span> <span class="nx">shapes</span><span class="p">.</span>
  <span class="nx">This</span> <span class="nx">color</span> <span class="o">is</span> <span class="nx">either</span> <span class="nx">specified</span> <span class="k">in</span> <span class="nx">terms</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">RGB</span> <span class="o">or</span> <span class="nx">HSB</span> <span class="nx">color</span> <span class="nx">depending</span> <span class="kc">on</span> <span class="nx">the</span>
  <span class="nx">current</span> <span class="o">&lt;</span><span class="nx">b</span><span class="o">&gt;</span><span class="nx">colorMode</span><span class="p">()</span><span class="o">&lt;/</span><span class="nx">b</span><span class="o">&gt;</span> <span class="p">(</span><span class="nx">the</span> <span class="nx">default</span> <span class="nx">color</span> <span class="nx">space</span> <span class="o">is</span> <span class="nx">RGB</span><span class="p">,</span> <span class="nx">with</span> <span class="nx">each</span>
  <span class="nx">value</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">range</span> <span class="nx">from</span> <span class="mi">0</span> <span class="nx">to</span> <span class="mi">255</span><span class="p">).</span>
  <span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span><span class="nx">When</span> <span class="nx">using</span> <span class="nx">hexadecimal</span> <span class="nx">notation</span> <span class="nx">to</span> <span class="nx">specify</span> <span class="nx">a</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">use</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span> <span class="o">or</span>
  <span class="s">&quot;0x&quot;</span> <span class="nx">before</span> <span class="nx">the</span> <span class="nx">values</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span> <span class="c1">#CCFFAA, 0xFFCCFFAA). The # syntax uses six</span>
  <span class="nx">digits</span> <span class="nx">to</span> <span class="nx">specify</span> <span class="nx">a</span> <span class="nx">color</span> <span class="p">(</span><span class="nx">the</span> <span class="nx">way</span> <span class="nx">colors</span> <span class="nx">are</span> <span class="nx">specified</span> <span class="k">in</span> <span class="nx">HTML</span> <span class="o">and</span> <span class="nx">CSS</span><span class="p">).</span>
  <span class="nx">When</span> <span class="nx">using</span> <span class="nx">the</span> <span class="nx">hexadecimal</span> <span class="nx">notation</span> <span class="nx">starting</span> <span class="nx">with</span> <span class="s">&quot;0x&quot;</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">hexadecimal</span>
  <span class="nx">value</span> <span class="nx">must</span> <span class="nx">be</span> <span class="nx">specified</span> <span class="nx">with</span> <span class="nx">eight</span> <span class="nx">characters</span><span class="p">;</span> <span class="nx">the</span> <span class="nx">first</span> <span class="nx">two</span> <span class="nx">characters</span>
  <span class="nx">define</span> <span class="nx">the</span> <span class="nx">alpha</span> <span class="nx">component</span> <span class="o">and</span> <span class="nx">the</span> <span class="nx">remainder</span> <span class="nx">the</span> <span class="nx">red</span><span class="p">,</span> <span class="nx">green</span><span class="p">,</span> <span class="o">and</span> <span class="nx">blue</span>
  <span class="nx">components</span><span class="p">.</span>
  <span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span><span class="nx">The</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">parameter</span> <span class="s">&quot;gray&quot;</span> <span class="nx">must</span> <span class="nx">be</span> <span class="nx">less</span> <span class="nx">than</span> <span class="o">or</span> <span class="nx">equal</span>
  <span class="nx">to</span> <span class="nx">the</span> <span class="nx">current</span> <span class="nx">maximum</span> <span class="nx">value</span> <span class="nx">as</span> <span class="nx">specified</span> <span class="k">by</span> <span class="o">&lt;</span><span class="nx">b</span><span class="o">&gt;</span><span class="nx">colorMode</span><span class="p">()</span><span class="o">&lt;/</span><span class="nx">b</span><span class="o">&gt;</span><span class="p">.</span>
  <span class="nx">The</span> <span class="nx">default</span> <span class="nx">maximum</span> <span class="nx">value</span> <span class="o">is</span> <span class="mi">255</span><span class="p">.</span>
  
  <span class="nx">@param</span> <span class="p">{</span><span class="nx">int</span><span class="o">|</span><span class="nx">float</span><span class="p">}</span> <span class="nx">gray</span>    <span class="nx">number</span> <span class="nx">specifying</span> <span class="nx">value</span> <span class="nx">between</span> <span class="nx">white</span> <span class="o">and</span> <span class="nx">black</span>
  <span class="nx">@param</span> <span class="p">{</span><span class="nx">int</span><span class="o">|</span><span class="nx">float</span><span class="p">}</span> <span class="nx">value1</span>  <span class="nx">red</span> <span class="o">or</span> <span class="nx">hue</span> <span class="nx">value</span>
  <span class="nx">@param</span> <span class="p">{</span><span class="nx">int</span><span class="o">|</span><span class="nx">float</span><span class="p">}</span> <span class="nx">value2</span>  <span class="nx">green</span> <span class="o">or</span> <span class="nx">saturation</span> <span class="nx">value</span>
  <span class="nx">@param</span> <span class="p">{</span><span class="nx">int</span><span class="o">|</span><span class="nx">float</span><span class="p">}</span> <span class="nx">value3</span>  <span class="nx">blue</span> <span class="o">or</span> <span class="nx">brightness</span> <span class="nx">value</span>
  <span class="nx">@param</span> <span class="p">{</span><span class="nx">int</span><span class="o">|</span><span class="nx">float</span><span class="p">}</span> <span class="nx">alpha</span>   <span class="nx">opacity</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">stroke</span>
  <span class="nx">@param</span> <span class="p">{</span><span class="nx">Color</span><span class="p">}</span> <span class="nx">color</span>       <span class="nx">any</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">color</span> <span class="nx">datatype</span>
  <span class="nx">@param</span> <span class="p">{</span><span class="nx">int</span><span class="p">}</span> <span class="nx">hex</span>           <span class="nx">color</span> <span class="nx">value</span> <span class="k">in</span> <span class="nx">hex</span> <span class="nx">notation</span> <span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">e</span><span class="p">.</span> <span class="c1">#FFCC00 or 0xFFFFCC00)</span>
  
  <span class="nx">@see</span> <span class="c1">#fill()</span>
  <span class="nx">@see</span> <span class="c1">#noStroke()</span>
  <span class="nx">@see</span> <span class="c1">#tint()</span>
  <span class="nx">@see</span> <span class="c1">#background()</span>
  <span class="nx">@see</span> <span class="c1">#colorMode()</span>
  
  <span class="nv">stroke: </span><span class="nf">(r, g, b, a) -&gt;</span>    </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>see comment on fill method above
for some comments on how this method works.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@doStroke = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">r</span> <span class="o">isnt</span> <span class="nx">angleColor</span>
      <span class="vi">@defaultNormalStroke = </span><span class="kc">false</span>
      <span class="vi">@currentStrokeColor = </span><span class="nx">color</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
      <span class="vi">@currentStrokeAlpha = </span><span class="nx">alphaZeroToOne</span><span class="p">(</span><span class="nx">color</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">))</span>
    <span class="k">else</span>
      </pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>we keep track of the "normal stroke" flag and the stroke color
separately because
we can do some smart optimisation later
and not draw the wireframe is it happens to be the same color as
the fill</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@defaultNormalStroke = </span><span class="kc">true</span>
      <span class="vi">@currentStrokeColor = </span><span class="nx">angleColor</span>
      <span class="k">if</span> <span class="nx">b</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span> <span class="o">and</span> <span class="nx">g</span> <span class="o">isnt</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
        <span class="vi">@currentStrokeAlpha = </span><span class="nx">g</span> <span class="o">/</span> <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">colourFunctions</span><span class="p">.</span><span class="nx">colorModeA</span>
      <span class="k">else</span>
        <span class="vi">@currentStrokeAlpha = </span><span class="mi">1</span>

  
  
  <span class="nx">The</span> <span class="nx">noStroke</span><span class="p">()</span> <span class="nx">function</span> <span class="nx">disables</span> <span class="nx">drawing</span> <span class="nx">the</span> <span class="nx">stroke</span> <span class="p">(</span><span class="nx">outline</span><span class="p">).</span>
  <span class="nx">If</span> <span class="nx">both</span> <span class="o">&lt;</span><span class="nx">b</span><span class="o">&gt;</span><span class="nx">noStroke</span><span class="p">()</span><span class="o">&lt;/</span><span class="nx">b</span><span class="o">&gt;</span> <span class="o">and</span> <span class="o">&lt;</span><span class="nx">b</span><span class="o">&gt;</span><span class="nx">noFill</span><span class="p">()</span><span class="o">&lt;/</span><span class="nx">b</span><span class="o">&gt;</span> <span class="nx">are</span> <span class="nx">called</span><span class="p">,</span> <span class="kc">no</span> <span class="nx">shapes</span>
  <span class="nx">will</span> <span class="nx">be</span> <span class="nx">drawn</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">screen</span><span class="p">.</span>
  
  <span class="nx">@see</span> <span class="c1">#stroke()</span>
  
  <span class="nv">noStroke: </span><span class="nf">-&gt;</span>
    <span class="vi">@doStroke = </span><span class="kc">false</span>

  <span class="nv">strokeSize: </span><span class="nf">(a) -&gt;</span>    </pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>note that either Three.js of the graphic card limit the size
of the stroke. This is because openGL strokes are VERY crude
(the cap is not even square, it's worse than that:
http://twolivesleft.com/Codea/LineCapShear.png )
So it's limited to 10. In some graphic cards this doesn't even have
any effect.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
      <span class="nv">a = </span><span class="mi">1</span>
    <span class="k">else</span> <span class="nv">a = </span><span class="mi">0</span>  <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="vi">@currentStrokeSize = </span><span class="nx">a</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 